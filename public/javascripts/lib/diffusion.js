!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.diffusion=e()}}(function(){var define;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(){},{}],2:[function(_dereq_,module,exports){function Buffer(subject,encoding,noZero){if(!(this instanceof Buffer))return new Buffer(subject,encoding,noZero);var length,type=typeof subject;if("number"===type)length=subject>0?subject>>>0:0;else if("string"===type)"base64"===encoding&&(subject=base64clean(subject)),length=Buffer.byteLength(subject,encoding);else{if("object"!==type||null===subject)throw new TypeError("must start with number, buffer, array or string");"Buffer"===subject.type&&isArray(subject.data)&&(subject=subject.data),length=+subject.length>0?Math.floor(+subject.length):0}if(this.length>kMaxLength)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+kMaxLength.toString(16)+" bytes");var buf;Buffer.TYPED_ARRAY_SUPPORT?buf=Buffer._augment(new Uint8Array(length)):(buf=this,buf.length=length,buf._isBuffer=!0);var i;if(Buffer.TYPED_ARRAY_SUPPORT&&"number"==typeof subject.byteLength)buf._set(subject);else if(isArrayish(subject))if(Buffer.isBuffer(subject))for(i=0;length>i;i++)buf[i]=subject.readUInt8(i);else for(i=0;length>i;i++)buf[i]=(subject[i]%256+256)%256;else if("string"===type)buf.write(subject,0,encoding);else if("number"===type&&!Buffer.TYPED_ARRAY_SUPPORT&&!noZero)for(i=0;length>i;i++)buf[i]=0;return buf}function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;length?(length=Number(length),length>remaining&&(length=remaining)):length=remaining;var strLen=string.length;if(strLen%2!==0)throw new Error("Invalid hex string");length>strLen/2&&(length=strLen/2);for(var i=0;length>i;i++){var byte=parseInt(string.substr(2*i,2),16);if(isNaN(byte))throw new Error("Invalid hex string");buf[offset+i]=byte}return i}function utf8Write(buf,string,offset,length){var charsWritten=blitBuffer(utf8ToBytes(string),buf,offset,length);return charsWritten}function asciiWrite(buf,string,offset,length){var charsWritten=blitBuffer(asciiToBytes(string),buf,offset,length);return charsWritten}function binaryWrite(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){var charsWritten=blitBuffer(base64ToBytes(string),buf,offset,length);return charsWritten}function utf16leWrite(buf,string,offset,length){var charsWritten=blitBuffer(utf16leToBytes(string),buf,offset,length,2);return charsWritten}function base64Slice(buf,start,end){return base64.fromByteArray(0===start&&end===buf.length?buf:buf.slice(start,end))}function utf8Slice(buf,start,end){var res="",tmp="";end=Math.min(buf.length,end);for(var i=start;end>i;i++)buf[i]<=127?(res+=decodeUtf8Char(tmp)+String.fromCharCode(buf[i]),tmp=""):tmp+="%"+buf[i].toString(16);return res+decodeUtf8Char(tmp)}function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;end>i;i++)ret+=String.fromCharCode(buf[i]);return ret}function binarySlice(buf,start,end){return asciiSlice(buf,start,end)}function hexSlice(buf,start,end){var len=buf.length;(!start||0>start)&&(start=0),(!end||0>end||end>len)&&(end=len);for(var out="",i=start;end>i;i++)out+=toHex(buf[i]);return out}function utf16leSlice(buf,start,end){for(var bytes=buf.slice(start,end),res="",i=0;i<bytes.length;i+=2)res+=String.fromCharCode(bytes[i]+256*bytes[i+1]);return res}function checkOffset(offset,ext,length){if(offset%1!==0||0>offset)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError("buffer must be a Buffer instance");if(value>max||min>value)throw new TypeError("value is out of bounds");if(offset+ext>buf.length)throw new TypeError("index out of range")}function objectWriteUInt16(buf,value,offset,littleEndian){0>value&&(value=65535+value+1);for(var i=0,j=Math.min(buf.length-offset,2);j>i;i++)buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>8*(littleEndian?i:1-i)}function objectWriteUInt32(buf,value,offset,littleEndian){0>value&&(value=4294967295+value+1);for(var i=0,j=Math.min(buf.length-offset,4);j>i;i++)buf[offset+i]=value>>>8*(littleEndian?i:3-i)&255}function checkIEEE754(buf,value,offset,ext,max,min){if(value>max||min>value)throw new TypeError("value is out of bounds");if(offset+ext>buf.length)throw new TypeError("index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,4,3.4028234663852886e38,-3.4028234663852886e38),ieee754.write(buf,value,offset,littleEndian,23,4),offset+4}function writeDouble(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,8,1.7976931348623157e308,-1.7976931348623157e308),ieee754.write(buf,value,offset,littleEndian,52,8),offset+8}function base64clean(str){for(str=stringtrim(str).replace(INVALID_BASE64_RE,"");str.length%4!==0;)str+="=";return str}function stringtrim(str){return str.trim?str.trim():str.replace(/^\s+|\s+$/g,"")}function isArrayish(subject){return isArray(subject)||Buffer.isBuffer(subject)||subject&&"object"==typeof subject&&"number"==typeof subject.length}function toHex(n){return 16>n?"0"+n.toString(16):n.toString(16)}function utf8ToBytes(str){for(var byteArray=[],i=0;i<str.length;i++){var b=str.charCodeAt(i);if(127>=b)byteArray.push(b);else{var start=i;b>=55296&&57343>=b&&i++;for(var h=encodeURIComponent(str.slice(start,i+1)).substr(1).split("%"),j=0;j<h.length;j++)byteArray.push(parseInt(h[j],16))}}return byteArray}function asciiToBytes(str){for(var byteArray=[],i=0;i<str.length;i++)byteArray.push(255&str.charCodeAt(i));return byteArray}function utf16leToBytes(str){for(var c,hi,lo,byteArray=[],i=0;i<str.length;i++)c=str.charCodeAt(i),hi=c>>8,lo=c%256,byteArray.push(lo),byteArray.push(hi);return byteArray}function base64ToBytes(str){return base64.toByteArray(str)}function blitBuffer(src,dst,offset,length,unitSize){unitSize&&(length-=length%unitSize);for(var i=0;length>i&&!(i+offset>=dst.length||i>=src.length);i++)dst[i+offset]=src[i];return i}function decodeUtf8Char(str){try{return decodeURIComponent(str)}catch(err){return String.fromCharCode(65533)}}var base64=_dereq_("base64-js"),ieee754=_dereq_("ieee754"),isArray=_dereq_("is-array");exports.Buffer=Buffer,exports.SlowBuffer=Buffer,exports.INSPECT_MAX_BYTES=50,Buffer.poolSize=8192;var kMaxLength=1073741823;Buffer.TYPED_ARRAY_SUPPORT=function(){try{var buf=new ArrayBuffer(0),arr=new Uint8Array(buf);return arr.foo=function(){return 42},42===arr.foo()&&"function"==typeof arr.subarray&&0===new Uint8Array(1).subarray(1,1).byteLength}catch(e){return!1}}(),Buffer.isBuffer=function(b){return!(null==b||!b._isBuffer)},Buffer.compare=function(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b))throw new TypeError("Arguments must be Buffers");for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);len>i&&a[i]===b[i];i++);return i!==len&&(x=a[i],y=b[i]),y>x?-1:x>y?1:0},Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(list,totalLength){if(!isArray(list))throw new TypeError("Usage: Buffer.concat(list[, length])");if(0===list.length)return new Buffer(0);if(1===list.length)return list[0];var i;if(void 0===totalLength)for(totalLength=0,i=0;i<list.length;i++)totalLength+=list[i].length;var buf=new Buffer(totalLength),pos=0;for(i=0;i<list.length;i++){var item=list[i];item.copy(buf,pos),pos+=item.length}return buf},Buffer.byteLength=function(str,encoding){var ret;switch(str+="",encoding||"utf8"){case"ascii":case"binary":case"raw":ret=str.length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":ret=2*str.length;break;case"hex":ret=str.length>>>1;break;case"utf8":case"utf-8":ret=utf8ToBytes(str).length;break;case"base64":ret=base64ToBytes(str).length;break;default:ret=str.length}return ret},Buffer.prototype.length=void 0,Buffer.prototype.parent=void 0,Buffer.prototype.toString=function(encoding,start,end){var loweredCase=!1;if(start>>>=0,end=void 0===end||1/0===end?this.length:end>>>0,encoding||(encoding="utf8"),0>start&&(start=0),end>this.length&&(end=this.length),start>=end)return"";for(;;)switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"binary":return binarySlice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase(),loweredCase=!0}},Buffer.prototype.equals=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return 0===Buffer.compare(this,b)},Buffer.prototype.inspect=function(){var str="",max=exports.INSPECT_MAX_BYTES;return this.length>0&&(str=this.toString("hex",0,max).match(/.{2}/g).join(" "),this.length>max&&(str+=" ... ")),"<Buffer "+str+">"},Buffer.prototype.compare=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return Buffer.compare(this,b)},Buffer.prototype.get=function(offset){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(offset)},Buffer.prototype.set=function(v,offset){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(v,offset)},Buffer.prototype.write=function(string,offset,length,encoding){if(isFinite(offset))isFinite(length)||(encoding=length,length=void 0);else{var swap=encoding;encoding=offset,offset=length,length=swap}offset=Number(offset)||0;var remaining=this.length-offset;length?(length=Number(length),length>remaining&&(length=remaining)):length=remaining,encoding=String(encoding||"utf8").toLowerCase();var ret;switch(encoding){case"hex":ret=hexWrite(this,string,offset,length);break;case"utf8":case"utf-8":ret=utf8Write(this,string,offset,length);break;case"ascii":ret=asciiWrite(this,string,offset,length);break;case"binary":ret=binaryWrite(this,string,offset,length);break;case"base64":ret=base64Write(this,string,offset,length);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":ret=utf16leWrite(this,string,offset,length);break;default:throw new TypeError("Unknown encoding: "+encoding)}return ret},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},Buffer.prototype.slice=function(start,end){var len=this.length;if(start=~~start,end=void 0===end?len:~~end,0>start?(start+=len,0>start&&(start=0)):start>len&&(start=len),0>end?(end+=len,0>end&&(end=0)):end>len&&(end=len),start>end&&(end=start),Buffer.TYPED_ARRAY_SUPPORT)return Buffer._augment(this.subarray(start,end));for(var sliceLen=end-start,newBuf=new Buffer(sliceLen,void 0,!0),i=0;sliceLen>i;i++)newBuf[i]=this[i+start];return newBuf},Buffer.prototype.readUInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),this[offset]},Buffer.prototype.readUInt16LE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]|this[offset+1]<<8},Buffer.prototype.readUInt16BE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]<<8|this[offset+1]},Buffer.prototype.readUInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+16777216*this[offset+3]},Buffer.prototype.readUInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),16777216*this[offset]+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])},Buffer.prototype.readInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),128&this[offset]?-1*(255-this[offset]+1):this[offset]},Buffer.prototype.readInt16LE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt16BE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24},Buffer.prototype.readInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]},Buffer.prototype.readFloatLE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!0,23,4)},Buffer.prototype.readFloatBE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!1,23,4)},Buffer.prototype.readDoubleLE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!0,52,8)},Buffer.prototype.readDoubleBE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!1,52,8)},Buffer.prototype.writeUInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,255,0),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),this[offset]=value,offset+1},Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset+3]=value>>>24,this[offset+2]=value>>>16,this[offset+1]=value>>>8,this[offset]=value):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,127,-128),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),0>value&&(value=255+value+1),this[offset]=value,offset+1},Buffer.prototype.writeInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value,this[offset+1]=value>>>8,this[offset+2]=value>>>16,this[offset+3]=value>>>24):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),0>value&&(value=4294967295+value+1),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeFloatLE=function(value,offset,noAssert){return writeFloat(this,value,offset,!0,noAssert)},Buffer.prototype.writeFloatBE=function(value,offset,noAssert){return writeFloat(this,value,offset,!1,noAssert)},Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){return writeDouble(this,value,offset,!0,noAssert)},Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){return writeDouble(this,value,offset,!1,noAssert)},Buffer.prototype.copy=function(target,target_start,start,end){var source=this;if(start||(start=0),end||0===end||(end=this.length),target_start||(target_start=0),end!==start&&0!==target.length&&0!==source.length){if(start>end)throw new TypeError("sourceEnd < sourceStart");if(0>target_start||target_start>=target.length)throw new TypeError("targetStart out of bounds");if(0>start||start>=source.length)throw new TypeError("sourceStart out of bounds");if(0>end||end>source.length)throw new TypeError("sourceEnd out of bounds");end>this.length&&(end=this.length),target.length-target_start<end-start&&(end=target.length-target_start+start);var len=end-start;if(1e3>len||!Buffer.TYPED_ARRAY_SUPPORT)for(var i=0;len>i;i++)target[i+target_start]=this[i+start];else target._set(this.subarray(start,start+len),target_start)}},Buffer.prototype.fill=function(value,start,end){if(value||(value=0),start||(start=0),end||(end=this.length),start>end)throw new TypeError("end < start");if(end!==start&&0!==this.length){if(0>start||start>=this.length)throw new TypeError("start out of bounds");if(0>end||end>this.length)throw new TypeError("end out of bounds");var i;if("number"==typeof value)for(i=start;end>i;i++)this[i]=value;else{var bytes=utf8ToBytes(value.toString()),len=bytes.length;for(i=start;end>i;i++)this[i]=bytes[i%len]}return this}},Buffer.prototype.toArrayBuffer=function(){if("undefined"!=typeof Uint8Array){if(Buffer.TYPED_ARRAY_SUPPORT)return new Buffer(this).buffer;for(var buf=new Uint8Array(this.length),i=0,len=buf.length;len>i;i+=1)buf[i]=this[i];return buf.buffer}throw new TypeError("Buffer.toArrayBuffer not supported in this browser")};var BP=Buffer.prototype;Buffer._augment=function(arr){return arr.constructor=Buffer,arr._isBuffer=!0,arr._get=arr.get,arr._set=arr.set,arr.get=BP.get,arr.set=BP.set,arr.write=BP.write,arr.toString=BP.toString,arr.toLocaleString=BP.toString,arr.toJSON=BP.toJSON,arr.equals=BP.equals,arr.compare=BP.compare,arr.copy=BP.copy,arr.slice=BP.slice,arr.readUInt8=BP.readUInt8,arr.readUInt16LE=BP.readUInt16LE,arr.readUInt16BE=BP.readUInt16BE,arr.readUInt32LE=BP.readUInt32LE,arr.readUInt32BE=BP.readUInt32BE,arr.readInt8=BP.readInt8,arr.readInt16LE=BP.readInt16LE,arr.readInt16BE=BP.readInt16BE,arr.readInt32LE=BP.readInt32LE,arr.readInt32BE=BP.readInt32BE,arr.readFloatLE=BP.readFloatLE,arr.readFloatBE=BP.readFloatBE,arr.readDoubleLE=BP.readDoubleLE,arr.readDoubleBE=BP.readDoubleBE,arr.writeUInt8=BP.writeUInt8,arr.writeUInt16LE=BP.writeUInt16LE,arr.writeUInt16BE=BP.writeUInt16BE,arr.writeUInt32LE=BP.writeUInt32LE,arr.writeUInt32BE=BP.writeUInt32BE,arr.writeInt8=BP.writeInt8,arr.writeInt16LE=BP.writeInt16LE,arr.writeInt16BE=BP.writeInt16BE,arr.writeInt32LE=BP.writeInt32LE,arr.writeInt32BE=BP.writeInt32BE,arr.writeFloatLE=BP.writeFloatLE,arr.writeFloatBE=BP.writeFloatBE,arr.writeDoubleLE=BP.writeDoubleLE,arr.writeDoubleBE=BP.writeDoubleBE,arr.fill=BP.fill,arr.inspect=BP.inspect,arr.toArrayBuffer=BP.toArrayBuffer,arr};var INVALID_BASE64_RE=/[^+\/0-9A-z]/g},{"base64-js":3,ieee754:4,"is-array":5}],3:[function(_dereq_,module,exports){var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";!function(exports){"use strict";function decode(elt){var code=elt.charCodeAt(0);return code===PLUS?62:code===SLASH?63:NUMBER>code?-1:NUMBER+10>code?code-NUMBER+26+26:UPPER+26>code?code-UPPER:LOWER+26>code?code-LOWER+26:void 0}function b64ToByteArray(b64){function push(v){arr[L++]=v}var i,j,l,tmp,placeHolders,arr;if(b64.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var len=b64.length;placeHolders="="===b64.charAt(len-2)?2:"="===b64.charAt(len-1)?1:0,arr=new Arr(3*b64.length/4-placeHolders),l=placeHolders>0?b64.length-4:b64.length;var L=0;for(i=0,j=0;l>i;i+=4,j+=3)tmp=decode(b64.charAt(i))<<18|decode(b64.charAt(i+1))<<12|decode(b64.charAt(i+2))<<6|decode(b64.charAt(i+3)),push((16711680&tmp)>>16),push((65280&tmp)>>8),push(255&tmp);return 2===placeHolders?(tmp=decode(b64.charAt(i))<<2|decode(b64.charAt(i+1))>>4,push(255&tmp)):1===placeHolders&&(tmp=decode(b64.charAt(i))<<10|decode(b64.charAt(i+1))<<4|decode(b64.charAt(i+2))>>2,push(tmp>>8&255),push(255&tmp)),arr}function uint8ToBase64(uint8){function encode(num){return lookup.charAt(num)}function tripletToBase64(num){return encode(num>>18&63)+encode(num>>12&63)+encode(num>>6&63)+encode(63&num)}var i,temp,length,extraBytes=uint8.length%3,output="";for(i=0,length=uint8.length-extraBytes;length>i;i+=3)temp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2],output+=tripletToBase64(temp);switch(extraBytes){case 1:temp=uint8[uint8.length-1],output+=encode(temp>>2),output+=encode(temp<<4&63),output+="==";break;case 2:temp=(uint8[uint8.length-2]<<8)+uint8[uint8.length-1],output+=encode(temp>>10),output+=encode(temp>>4&63),output+=encode(temp<<2&63),output+="="}return output}var Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,PLUS="+".charCodeAt(0),SLASH="/".charCodeAt(0),NUMBER="0".charCodeAt(0),LOWER="a".charCodeAt(0),UPPER="A".charCodeAt(0);exports.toByteArray=b64ToByteArray,exports.fromByteArray=uint8ToBase64}("undefined"==typeof exports?this.base64js={}:exports)},{}],4:[function(_dereq_,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?0/0:1/0*(s?-1:1);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=0>value||0===value&&0>1/value?1:0;for(value=Math.abs(value),isNaN(value)||1/0===value?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias),value*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s}},{}],5:[function(_dereq_,module){var isArray=Array.isArray,str=Object.prototype.toString;module.exports=isArray||function(val){return!!val&&"[object Array]"==str.call(val)}},{}],6:[function(_dereq_,module){function noop(){}var process=module.exports={};process.nextTick=function(){var canSetImmediate="undefined"!=typeof window&&window.setImmediate,canPost="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(canSetImmediate)return function(f){return window.setImmediate(f)};if(canPost){var queue=[];return window.addEventListener("message",function(ev){var source=ev.source;if((source===window||null===source)&&"process-tick"===ev.data&&(ev.stopPropagation(),queue.length>0)){var fn=queue.shift();fn()}},!0),function(fn){queue.push(fn),window.postMessage("process-tick","*")}}return function(fn){setTimeout(fn,0)}}(),process.title="browser",process.browser=!0,process.env={},process.argv=[],process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.binding=function(){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(){throw new Error("process.chdir is not supported")}},{}],7:[function(_dereq_,module){module.exports=function(arg){return arg&&"object"==typeof arg&&"function"==typeof arg.copy&&"function"==typeof arg.fill&&"function"==typeof arg.readUInt8}},{}],8:[function(_dereq_,module,exports){(function(process,global){function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};return arguments.length>=3&&(ctx.depth=arguments[2]),arguments.length>=4&&(ctx.colors=arguments[3]),isBoolean(opts)?ctx.showHidden=opts:opts&&exports._extend(ctx,opts),isUndefined(ctx.showHidden)&&(ctx.showHidden=!1),isUndefined(ctx.depth)&&(ctx.depth=2),isUndefined(ctx.colors)&&(ctx.colors=!1),isUndefined(ctx.customInspect)&&(ctx.customInspect=!0),ctx.colors&&(ctx.stylize=stylizeWithColor),formatValue(ctx,obj,ctx.depth)}function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];return style?"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m":str}function stylizeNoColor(str){return str}function arrayToHash(array){var hash={};return array.forEach(function(val){hash[val]=!0}),hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&(!value.constructor||value.constructor.prototype!==value)){var ret=value.inspect(recurseTimes,ctx);return isString(ret)||(ret=formatValue(ctx,ret,recurseTimes)),ret}var primitive=formatPrimitive(ctx,value);if(primitive)return primitive;var keys=Object.keys(value),visibleKeys=arrayToHash(keys);if(ctx.showHidden&&(keys=Object.getOwnPropertyNames(value)),isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0))return formatError(value);if(0===keys.length){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value))return ctx.stylize(RegExp.prototype.toString.call(value),"regexp");if(isDate(value))return ctx.stylize(Date.prototype.toString.call(value),"date");if(isError(value))return formatError(value)}var base="",array=!1,braces=["{","}"];if(isArray(value)&&(array=!0,braces=["[","]"]),isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)&&(base=" "+RegExp.prototype.toString.call(value)),isDate(value)&&(base=" "+Date.prototype.toUTCString.call(value)),isError(value)&&(base=" "+formatError(value)),0===keys.length&&(!array||0==value.length))return braces[0]+base+braces[1];if(0>recurseTimes)return isRegExp(value)?ctx.stylize(RegExp.prototype.toString.call(value),"regexp"):ctx.stylize("[Object]","special");ctx.seen.push(value);var output;return output=array?formatArray(ctx,value,recurseTimes,visibleKeys,keys):keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)}),ctx.seen.pop(),reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}return isNumber(value)?ctx.stylize(""+value,"number"):isBoolean(value)?ctx.stylize(""+value,"boolean"):isNull(value)?ctx.stylize("null","null"):void 0}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){for(var output=[],i=0,l=value.length;l>i;++i)output.push(hasOwnProperty(value,String(i))?formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),!0):"");return keys.forEach(function(key){key.match(/^\d+$/)||output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,!0))}),output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;if(desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]},desc.get?str=desc.set?ctx.stylize("[Getter/Setter]","special"):ctx.stylize("[Getter]","special"):desc.set&&(str=ctx.stylize("[Setter]","special")),hasOwnProperty(visibleKeys,key)||(name="["+key+"]"),str||(ctx.seen.indexOf(desc.value)<0?(str=isNull(recurseTimes)?formatValue(ctx,desc.value,null):formatValue(ctx,desc.value,recurseTimes-1),str.indexOf("\n")>-1&&(str=array?str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2):"\n"+str.split("\n").map(function(line){return"   "+line}).join("\n"))):str=ctx.stylize("[Circular]","special")),isUndefined(name)){if(array&&key.match(/^\d+$/))return str;name=JSON.stringify(""+key),name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(name=name.substr(1,name.length-2),name=ctx.stylize(name,"name")):(name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),name=ctx.stylize(name,"string"))}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0,length=output.reduce(function(prev,cur){return numLinesEst++,cur.indexOf("\n")>=0&&numLinesEst++,prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);return length>60?braces[0]+(""===base?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]:braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}function isBoolean(arg){return"boolean"==typeof arg}function isNull(arg){return null===arg}function isNullOrUndefined(arg){return null==arg}function isNumber(arg){return"number"==typeof arg}function isString(arg){return"string"==typeof arg}function isSymbol(arg){return"symbol"==typeof arg}function isUndefined(arg){return void 0===arg}function isRegExp(re){return isObject(re)&&"[object RegExp]"===objectToString(re)}function isObject(arg){return"object"==typeof arg&&null!==arg}function isDate(d){return isObject(d)&&"[object Date]"===objectToString(d)}function isError(e){return isObject(e)&&("[object Error]"===objectToString(e)||e instanceof Error)}function isFunction(arg){return"function"==typeof arg}function isPrimitive(arg){return null===arg||"boolean"==typeof arg||"number"==typeof arg||"string"==typeof arg||"symbol"==typeof arg||"undefined"==typeof arg}function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return 10>n?"0"+n.toString(10):n.toString(10)}function timestamp(){var d=new Date,time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){for(var objects=[],i=0;i<arguments.length;i++)objects.push(inspect(arguments[i]));return objects.join(" ")}for(var i=1,args=arguments,len=args.length,str=String(f).replace(formatRegExp,function(x){if("%%"===x)return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}}),x=args[i];len>i;x=args[++i])str+=isNull(x)||!isObject(x)?" "+x:" "+inspect(x);return str},exports.deprecate=function(fn,msg){function deprecated(){if(!warned){if(process.throwDeprecation)throw new Error(msg);process.traceDeprecation?console.trace(msg):console.error(msg),warned=!0}return fn.apply(this,arguments)}if(isUndefined(global.process))return function(){return exports.deprecate(fn,msg).apply(this,arguments)
};if(process.noDeprecation===!0)return fn;var warned=!1;return deprecated};var debugEnviron,debugs={};exports.debuglog=function(set){if(isUndefined(debugEnviron)&&(debugEnviron=process.env.NODE_DEBUG||""),set=set.toUpperCase(),!debugs[set])if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else debugs[set]=function(){};return debugs[set]},exports.inspect=inspect,inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"},exports.isArray=isArray,exports.isBoolean=isBoolean,exports.isNull=isNull,exports.isNullOrUndefined=isNullOrUndefined,exports.isNumber=isNumber,exports.isString=isString,exports.isSymbol=isSymbol,exports.isUndefined=isUndefined,exports.isRegExp=isRegExp,exports.isObject=isObject,exports.isDate=isDate,exports.isError=isError,exports.isFunction=isFunction,exports.isPrimitive=isPrimitive,exports.isBuffer=_dereq_("./support/isBuffer");var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))},exports.inherits=_dereq_("inherits"),exports._extend=function(origin,add){if(!add||!isObject(add))return origin;for(var keys=Object.keys(add),i=keys.length;i--;)origin[keys[i]]=add[keys[i]];return origin}}).call(this,_dereq_("Zbi7gb"),"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./support/isBuffer":7,Zbi7gb:6,inherits:10}],9:[function(_dereq_,module,exports){!function(factory){"function"==typeof define&&define.amd?define([],factory):"object"==typeof exports?exports.HashMap=factory():this.HashMap=factory()}(function(){function HashMap(){this.clear()}function hide(obj,prop){Object.defineProperty&&Object.defineProperty(obj,prop,{enumerable:!1})}return HashMap.prototype={constructor:HashMap,get:function(key){var data=this._data[this.hash(key)];return data&&data[1]},set:function(key,value){this._data[this.hash(key)]=[key,value]},has:function(key){return this.hash(key)in this._data},remove:function(key){delete this._data[this.hash(key)]},type:function(key){var str=Object.prototype.toString.call(key),type=str.slice(8,-1).toLowerCase();return"domwindow"!==type||key?type:key+""},keys:function(){var keys=[];return this.forEach(function(value,key){keys.push(key)}),keys},values:function(){var values=[];return this.forEach(function(value){values.push(value)}),values},count:function(){return this.keys().length},clear:function(){this._data={}},hash:function(key){switch(this.type(key)){case"undefined":case"null":case"boolean":case"number":case"regexp":return key+"";case"date":return":"+key.getTime();case"string":return'"'+key;case"array":for(var hashes=[],i=0;i<key.length;i++)hashes[i]=this.hash(key[i]);return"["+hashes.join("|");case"object":default:return key._hmuid_||(key._hmuid_=++HashMap.uid,hide(key,"_hmuid_")),"{"+key._hmuid_}},forEach:function(func){for(var key in this._data){var data=this._data[key];func.call(this,data[1],data[0])}}},HashMap.uid=0,HashMap})},{}],10:[function(_dereq_,module){module.exports="function"==typeof Object.create?function(ctor,superCtor){ctor.super_=superCtor,ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:!1,writable:!0,configurable:!0}})}:function(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}},{}],11:[function(_dereq_,module){!function(root,definition){"object"==typeof module&&module.exports&&"function"==typeof _dereq_?module.exports=definition():"function"==typeof define&&"object"==typeof define.amd?define(definition):root.log=definition()}(this,function(){function realMethod(methodName){return typeof console===undefinedType?noop:void 0===console[methodName]?void 0!==console.log?boundToConsole(console,"log"):noop:boundToConsole(console,methodName)}function boundToConsole(console,methodName){var method=console[methodName];if(void 0!==method.bind)return console[methodName].bind(console);if(void 0===Function.prototype.bind)return functionBindingWrapper(method,console);try{return Function.prototype.bind.call(console[methodName],console)}catch(e){return functionBindingWrapper(method,console)}}function functionBindingWrapper(f,context){return function(){Function.prototype.apply.apply(f,[context,arguments])}}function replaceLoggingMethods(methodFactory){for(var ii=0;ii<logMethods.length;ii++)self[logMethods[ii]]=methodFactory(logMethods[ii])}function cookiesAvailable(){return typeof window!==undefinedType&&void 0!==window.document&&void 0!==window.document.cookie}function localStorageAvailable(){try{return typeof window!==undefinedType&&void 0!==window.localStorage&&null!==window.localStorage}catch(e){return!1}}function persistLevelIfPossible(levelNum){var levelName,localStorageFail=!1;for(var key in self.levels)if(self.levels.hasOwnProperty(key)&&self.levels[key]===levelNum){levelName=key;break}if(localStorageAvailable())try{window.localStorage.loglevel=levelName}catch(e){localStorageFail=!0}else localStorageFail=!0;localStorageFail&&cookiesAvailable()&&(window.document.cookie="loglevel="+levelName+";")}function loadPersistedLevel(){var storedLevel;if(localStorageAvailable()&&(storedLevel=window.localStorage.loglevel),void 0===storedLevel&&cookiesAvailable()){var cookieMatch=cookieRegex.exec(window.document.cookie)||[];storedLevel=cookieMatch[1]}void 0===self.levels[storedLevel]&&(storedLevel="WARN"),self.setLevel(self.levels[storedLevel])}var self={},noop=function(){},undefinedType="undefined",logMethods=["trace","debug","info","warn","error"],cookieRegex=/loglevel=([^;]+)/;self.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},self.setLevel=function(level){if("number"==typeof level&&level>=0&&level<=self.levels.SILENT){if(persistLevelIfPossible(level),level===self.levels.SILENT)return void replaceLoggingMethods(function(){return noop});if(typeof console===undefinedType)return replaceLoggingMethods(function(methodName){return function(){typeof console!==undefinedType&&(self.setLevel(level),self[methodName].apply(self,arguments))}}),"No console available for logging";replaceLoggingMethods(function(methodName){return level<=self.levels[methodName.toUpperCase()]?realMethod(methodName):noop})}else{if("string"!=typeof level||void 0===self.levels[level.toUpperCase()])throw"log.setLevel() called with invalid level: "+level;self.setLevel(self.levels[level.toUpperCase()])}},self.enableAll=function(){self.setLevel(self.levels.TRACE)},self.disableAll=function(){self.setLevel(self.levels.SILENT)};var _log=typeof window!==undefinedType?window.log:void 0;return self.noConflict=function(){return typeof window!==undefinedType&&window.log===self&&(window.log=_log),self},loadPersistedLevel(),self})},{}],12:[function(_dereq_,module){!function(global){"use strict";var Long=function(low,high,unsigned){this.low=0|low,this.high=0|high,this.unsigned=!!unsigned};Long.isLong=function(obj){return(obj&&obj instanceof Long)===!0};var INT_CACHE={},UINT_CACHE={};Long.fromInt=function(value,unsigned){var obj,cachedObj;return unsigned?(value>>>=0,value>=0&&256>value&&(cachedObj=UINT_CACHE[value])?cachedObj:(obj=new Long(value,0>(0|value)?-1:0,!0),value>=0&&256>value&&(UINT_CACHE[value]=obj),obj)):(value=0|value,value>=-128&&128>value&&(cachedObj=INT_CACHE[value])?cachedObj:(obj=new Long(value,0>value?-1:0,!1),value>=-128&&128>value&&(INT_CACHE[value]=obj),obj))},Long.fromNumber=function(value,unsigned){return unsigned=!!unsigned,isNaN(value)||!isFinite(value)?Long.ZERO:!unsigned&&-TWO_PWR_63_DBL>=value?Long.MIN_VALUE:!unsigned&&value+1>=TWO_PWR_63_DBL?Long.MAX_VALUE:unsigned&&value>=TWO_PWR_64_DBL?Long.MAX_UNSIGNED_VALUE:0>value?Long.fromNumber(-value,unsigned).negate():new Long(value%TWO_PWR_32_DBL|0,value/TWO_PWR_32_DBL|0,unsigned)},Long.fromBits=function(lowBits,highBits,unsigned){return new Long(lowBits,highBits,unsigned)},Long.fromString=function(str,unsigned,radix){if(0===str.length)throw Error("number format error: empty string");if("NaN"===str||"Infinity"===str||"+Infinity"===str||"-Infinity"===str)return Long.ZERO;if("number"==typeof unsigned&&(radix=unsigned,unsigned=!1),radix=radix||10,2>radix||radix>36)throw Error("radix out of range: "+radix);var p;if((p=str.indexOf("-"))>0)throw Error('number format error: interior "-" character: '+str);if(0===p)return Long.fromString(str.substring(1),unsigned,radix).negate();for(var radixToPower=Long.fromNumber(Math.pow(radix,8)),result=Long.ZERO,i=0;i<str.length;i+=8){var size=Math.min(8,str.length-i),value=parseInt(str.substring(i,i+size),radix);if(8>size){var power=Long.fromNumber(Math.pow(radix,size));result=result.multiply(power).add(Long.fromNumber(value))}else result=result.multiply(radixToPower),result=result.add(Long.fromNumber(value))}return result.unsigned=unsigned,result},Long.fromValue=function(val){return"number"==typeof val?Long.fromNumber(val):"string"==typeof val?Long.fromString(val):Long.isLong(val)?val:new Long(val.low,val.high,val.unsigned)};var TWO_PWR_16_DBL=65536,TWO_PWR_32_DBL=TWO_PWR_16_DBL*TWO_PWR_16_DBL,TWO_PWR_64_DBL=TWO_PWR_32_DBL*TWO_PWR_32_DBL,TWO_PWR_63_DBL=TWO_PWR_64_DBL/2,TWO_PWR_24=Long.fromInt(1<<24);Long.ZERO=Long.fromInt(0),Long.UZERO=Long.fromInt(0,!0),Long.ONE=Long.fromInt(1),Long.UONE=Long.fromInt(1,!0),Long.NEG_ONE=Long.fromInt(-1),Long.MAX_VALUE=Long.fromBits(-1,2147483647,!1),Long.MAX_UNSIGNED_VALUE=Long.fromBits(-1,-1,!0),Long.MIN_VALUE=Long.fromBits(0,-2147483648,!1),Long.prototype.toInt=function(){return this.unsigned?this.low>>>0:this.low},Long.prototype.toNumber=function(){return this.unsigned?(this.high>>>0)*TWO_PWR_32_DBL+(this.low>>>0):this.high*TWO_PWR_32_DBL+(this.low>>>0)},Long.prototype.toString=function(radix){if(radix=radix||10,2>radix||radix>36)throw RangeError("radix out of range: "+radix);if(this.isZero())return"0";var rem;if(this.isNegative()){if(this.equals(Long.MIN_VALUE)){var radixLong=Long.fromNumber(radix),div=this.div(radixLong);return rem=div.multiply(radixLong).subtract(this),div.toString(radix)+rem.toInt().toString(radix)}return"-"+this.negate().toString(radix)}var radixToPower=Long.fromNumber(Math.pow(radix,6),this.unsigned);rem=this;for(var result="";;){var remDiv=rem.div(radixToPower),intval=rem.subtract(remDiv.multiply(radixToPower)).toInt()>>>0,digits=intval.toString(radix);if(rem=remDiv,rem.isZero())return digits+result;for(;digits.length<6;)digits="0"+digits;result=""+digits+result}},Long.prototype.getHighBits=function(){return this.high},Long.prototype.getHighBitsUnsigned=function(){return this.high>>>0},Long.prototype.getLowBits=function(){return this.low},Long.prototype.getLowBitsUnsigned=function(){return this.low>>>0},Long.prototype.getNumBitsAbs=function(){if(this.isNegative())return this.equals(Long.MIN_VALUE)?64:this.negate().getNumBitsAbs();for(var val=0!=this.high?this.high:this.low,bit=31;bit>0&&0==(val&1<<bit);bit--);return 0!=this.high?bit+33:bit+1},Long.prototype.isZero=function(){return 0===this.high&&0===this.low},Long.prototype.isNegative=function(){return!this.unsigned&&this.high<0},Long.prototype.isPositive=function(){return this.unsigned||this.high>=0},Long.prototype.isOdd=function(){return 1===(1&this.low)},Long.prototype.isEven=function(){return 0===(1&this.low)},Long.prototype.equals=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),this.unsigned!==other.unsigned&&this.high>>>31!==other.high>>>31?!1:this.high===other.high&&this.low===other.low},Long.prototype.notEquals=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),!this.equals(other)},Long.prototype.lessThan=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),this.compare(other)<0},Long.prototype.lessThanOrEqual=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),this.compare(other)<=0},Long.prototype.greaterThan=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),this.compare(other)>0},Long.prototype.greaterThanOrEqual=function(other){return this.compare(other)>=0},Long.prototype.compare=function(other){if(this.equals(other))return 0;var thisNeg=this.isNegative(),otherNeg=other.isNegative();return thisNeg&&!otherNeg?-1:!thisNeg&&otherNeg?1:this.unsigned?other.high>>>0>this.high>>>0||other.high===this.high&&other.low>>>0>this.low>>>0?-1:1:this.subtract(other).isNegative()?-1:1},Long.prototype.negate=function(){return!this.unsigned&&this.equals(Long.MIN_VALUE)?Long.MIN_VALUE:this.not().add(Long.ONE)},Long.prototype.add=function(addend){Long.isLong(addend)||(addend=Long.fromValue(addend));var a48=this.high>>>16,a32=65535&this.high,a16=this.low>>>16,a00=65535&this.low,b48=addend.high>>>16,b32=65535&addend.high,b16=addend.low>>>16,b00=65535&addend.low,c48=0,c32=0,c16=0,c00=0;return c00+=a00+b00,c16+=c00>>>16,c00&=65535,c16+=a16+b16,c32+=c16>>>16,c16&=65535,c32+=a32+b32,c48+=c32>>>16,c32&=65535,c48+=a48+b48,c48&=65535,Long.fromBits(c16<<16|c00,c48<<16|c32,this.unsigned)},Long.prototype.subtract=function(subtrahend){return Long.isLong(subtrahend)||(subtrahend=Long.fromValue(subtrahend)),this.add(subtrahend.negate())},Long.prototype.multiply=function(multiplier){if(this.isZero())return Long.ZERO;if(Long.isLong(multiplier)||(multiplier=Long.fromValue(multiplier)),multiplier.isZero())return Long.ZERO;if(this.equals(Long.MIN_VALUE))return multiplier.isOdd()?Long.MIN_VALUE:Long.ZERO;if(multiplier.equals(Long.MIN_VALUE))return this.isOdd()?Long.MIN_VALUE:Long.ZERO;if(this.isNegative())return multiplier.isNegative()?this.negate().multiply(multiplier.negate()):this.negate().multiply(multiplier).negate();if(multiplier.isNegative())return this.multiply(multiplier.negate()).negate();if(this.lessThan(TWO_PWR_24)&&multiplier.lessThan(TWO_PWR_24))return Long.fromNumber(this.toNumber()*multiplier.toNumber(),this.unsigned);var a48=this.high>>>16,a32=65535&this.high,a16=this.low>>>16,a00=65535&this.low,b48=multiplier.high>>>16,b32=65535&multiplier.high,b16=multiplier.low>>>16,b00=65535&multiplier.low,c48=0,c32=0,c16=0,c00=0;return c00+=a00*b00,c16+=c00>>>16,c00&=65535,c16+=a16*b00,c32+=c16>>>16,c16&=65535,c16+=a00*b16,c32+=c16>>>16,c16&=65535,c32+=a32*b00,c48+=c32>>>16,c32&=65535,c32+=a16*b16,c48+=c32>>>16,c32&=65535,c32+=a00*b32,c48+=c32>>>16,c32&=65535,c48+=a48*b00+a32*b16+a16*b32+a00*b48,c48&=65535,Long.fromBits(c16<<16|c00,c48<<16|c32,this.unsigned)},Long.prototype.div=function(divisor){if(Long.isLong(divisor)||(divisor=Long.fromValue(divisor)),divisor.isZero())throw new Error("division by zero");if(this.isZero())return this.unsigned?Long.UZERO:Long.ZERO;var approx,rem,res;if(this.equals(Long.MIN_VALUE)){if(divisor.equals(Long.ONE)||divisor.equals(Long.NEG_ONE))return Long.MIN_VALUE;if(divisor.equals(Long.MIN_VALUE))return Long.ONE;var halfThis=this.shiftRight(1);return approx=halfThis.div(divisor).shiftLeft(1),approx.equals(Long.ZERO)?divisor.isNegative()?Long.ONE:Long.NEG_ONE:(rem=this.subtract(divisor.multiply(approx)),res=approx.add(rem.div(divisor)))}if(divisor.equals(Long.MIN_VALUE))return this.unsigned?Long.UZERO:Long.ZERO;if(this.isNegative())return divisor.isNegative()?this.negate().div(divisor.negate()):this.negate().div(divisor).negate();if(divisor.isNegative())return this.div(divisor.negate()).negate();for(res=Long.ZERO,rem=this;rem.greaterThanOrEqual(divisor);){approx=Math.max(1,Math.floor(rem.toNumber()/divisor.toNumber()));for(var log2=Math.ceil(Math.log(approx)/Math.LN2),delta=48>=log2?1:Math.pow(2,log2-48),approxRes=Long.fromNumber(approx),approxRem=approxRes.multiply(divisor);approxRem.isNegative()||approxRem.greaterThan(rem);)approx-=delta,approxRes=Long.fromNumber(approx,this.unsigned),approxRem=approxRes.multiply(divisor);approxRes.isZero()&&(approxRes=Long.ONE),res=res.add(approxRes),rem=rem.subtract(approxRem)}return res},Long.prototype.modulo=function(divisor){return Long.isLong(divisor)||(divisor=Long.fromValue(divisor)),this.subtract(this.div(divisor).multiply(divisor))},Long.prototype.not=function(){return Long.fromBits(~this.low,~this.high,this.unsigned)},Long.prototype.and=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),Long.fromBits(this.low&other.low,this.high&other.high,this.unsigned)},Long.prototype.or=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),Long.fromBits(this.low|other.low,this.high|other.high,this.unsigned)},Long.prototype.xor=function(other){return Long.isLong(other)||(other=Long.fromValue(other)),Long.fromBits(this.low^other.low,this.high^other.high,this.unsigned)},Long.prototype.shiftLeft=function(numBits){return Long.isLong(numBits)&&(numBits=numBits.toInt()),0===(numBits&=63)?this:32>numBits?Long.fromBits(this.low<<numBits,this.high<<numBits|this.low>>>32-numBits,this.unsigned):Long.fromBits(0,this.low<<numBits-32,this.unsigned)},Long.prototype.shiftRight=function(numBits){return Long.isLong(numBits)&&(numBits=numBits.toInt()),0===(numBits&=63)?this:32>numBits?Long.fromBits(this.low>>>numBits|this.high<<32-numBits,this.high>>numBits,this.unsigned):Long.fromBits(this.high>>numBits-32,this.high>=0?0:-1,this.unsigned)},Long.prototype.shiftRightUnsigned=function(numBits){if(Long.isLong(numBits)&&(numBits=numBits.toInt()),numBits&=63,0===numBits)return this;var high=this.high;if(32>numBits){var low=this.low;return Long.fromBits(low>>>numBits|high<<32-numBits,high>>>numBits,this.unsigned)}return 32===numBits?Long.fromBits(high,0,this.unsigned):Long.fromBits(high>>>numBits-32,0,this.unsigned)},Long.prototype.toSigned=function(){return this.unsigned?new Long(this.low,this.high,!1):this},Long.prototype.toUnsigned=function(){return this.unsigned?this:new Long(this.low,this.high,!0)},"undefined"!=typeof module&&module.exports?module.exports=Long:"function"==typeof define&&define.amd?define(function(){return Long}):(global.dcodeIO=global.dcodeIO||{}).Long=Long}(this)},{}],13:[function(_dereq_,module){module.exports=_dereq_("./dist/Long.js")},{"./dist/Long.js":12}],14:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],RecordContent=interface("RecordContent",["get","records","forEach"]);RecordContent.Record=interface("Record",["get","fields","forEach"]),RecordContent.Builder=interface("RecordContentBuilder",["add","set","build"]),RecordContent.Builder.Record=interface("RecordContentRecordBuilder",["add","set"]),module.exports=RecordContent},{"util/interface":125}],15:[function(_dereq_,module){var Session=_dereq_("./session"),Metadata=_dereq_("metadata/metadata"),TopicSelectors=_dereq_("./topics/topic-selectors"),log=_dereq_("util/logger"),diffusion={version:"5.2.0",build:"0_01#28129",log:function(level){log.setLevel(level)},Session:Session,connect:function(options){return new Session(options).connect()},selectors:TopicSelectors,metadata:Metadata};module.exports=diffusion},{"./session":138,"./topics/topic-selectors":140,"metadata/metadata":60,"util/logger":126}],16:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],Stream=_dereq_("./stream");module.exports=interface("Result",Stream,[])},{"./stream":17,"util/interface":125}],17:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"];module.exports=interface("Stream",["on","off"])},{"util/interface":125}],18:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],Stream=_dereq_("./stream");module.exports=interface("Subscription",Stream,["selector","view","transform"])},{"./stream":17,"util/interface":125}],19:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],Stream=_dereq_("./stream");module.exports=interface("View",Stream,["get"])},{"./stream":17,"util/interface":125}],20:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],ErrorReport=interface("ErrorReport",["message","line","column"]),SystemPrincipal=interface("SystemPrincipal",["name","roles"]),Configuration=interface("SystemAuthenticationConfiguration",["principals","anonymous"]),ScriptBuilder=interface("ScriptBuilder",["script","assignRoles","addPrincipal","setPassword","verifyPassword","removePrincipal","allowAnonymousConnections","denyAnonymousConnections","abstainAnonymousConnections"]),Security=interface("Security",["getSystemAuthentication","updateSystemAuthentication","createScriptBuilder"]);module.exports.Security=Security,module.exports.ErrorReport=ErrorReport,module.exports.Configuration=Configuration,module.exports.ScriptBuilder=ScriptBuilder,module.exports.SystemPrincipal=SystemPrincipal},{"util/interface":125}],21:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"];module.exports.TopicControl=interface("TopicControl",["add","remove","removeWithSession","update"])},{"util/interface":125}],22:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],Topics=interface("Topics",["subscribe","unsubscribe","view"]);Topics.UnsubscribeReason={REQUESTED:{id:0,message:"The unsubscription was requested by this client"},CONTROL:{id:1,message:"The server or another client unsubscribed this client"},REMOVED:{id:2,message:"The topic was removed"}},module.exports=Topics},{"util/interface":125}],23:[function(_dereq_,module){var interface=_dereq_("util/interface")["interface"],Metadata=interface("Metadata",["String","Integer","Decimal","Stateless","RecordContent"]);Metadata.Stateless=interface("Stateless",[]),Metadata.String=interface("String",["value"]),Metadata.Integer=interface("Integer",["value"]),Metadata.Decimal=interface("Decimal",["value","scale"]),Metadata.RecordContent=interface("RecordContent",["occurs","addRecord","getRecord","getRecords","string","integer","decimal","builder","parse"]),Metadata.RecordContent.Record=interface("Record",["name","occurs","addField","getField","getFields"]),Metadata.RecordContent.Field=interface("MField",["name","type","occurs"]),module.exports=Metadata},{"util/interface":125}],24:[function(_dereq_,module){function quoteAndEscape(str){var escaped="'",i=0;if(str.indexOf("'")<0&&str.indexOf("\\")<0)escaped+=str;else for(;i<str.length;++i){var c=str[i];("'"===c||"\\"===c)&&(escaped+="\\"),escaped+=c}return escaped+="'"}function rolesToString(roles){return"["+roles.map(quoteAndEscape).join(" ")+"]"}var GET_SYSTEM_AUTHENTICATION=_dereq_("services/services").GET_SYSTEM_AUTHENTICATION,UPDATE_SYSTEM_AUTHENTICATION=_dereq_("services/services").UPDATE_SYSTEM_AUTHENTICATION,requireNonNull=_dereq_("util/require-non-null"),implements=_dereq_("util/interface")["implements"],api=_dereq_("../../../features/security"),SecurityCommandScript=_dereq_("services/authentication/security-command-script"),Emitter=(_dereq_("services/authentication/security-command-script-result"),_dereq_("events/emitter")),Result=_dereq_("events/result"),ErrorReport=(_dereq_("util/logger").create("Security"),implements(api.ErrorReport,{__constructor:function(message,line,column){this.message=requireNonNull(message),this.line=line||0,this.column=column||0},toString:function(){return"ErrorReport ["+this.message+" at ["+this.line+":"+this.column+"]]"}})),Configuration=implements(api.Configuration,{__constructor:function(principals,action,roles){this.principals=principals||[],this.anonymous={action:action,roles:roles||[]}},toString:function(){return"SystemAuthenticationConfiguration [principals="+this.principals+", anonymous="+this.anonymous+"]"}});Configuration.CONNECTION_ACTION={ALLOW:{id:0,value:"allow"},DENY:{id:1,value:"deny"},ABSTAIN:{id:2,value:"abstain"},fromString:function(val){return this[val.toUpperCase()]}};var SystemPrincipal=implements(api.SystemPrincipal,{__constructor:function(name,roles){this.name=requireNonNull(name),this.roles=roles||[]},toString:function(){return"SystemPrincipal ["+this.name+", "+this.roles+"]"}}),ScriptBuilder=implements(api.ScriptBuilder,function(commands){commands=commands||"";var withCommand=function(command){return new ScriptBuilder(commands?commands+"\n"+command:command)};this.script=function(){return commands},this.toString=function(){return"ScriptBuilder ["+commands+"]"},this.assignRoles=function(principal,roles){return withCommand("assign roles "+quoteAndEscape(requireNonNull(principal,"principal"))+" "+rolesToString(requireNonNull(roles,"roles")))},this.addPrincipal=function(principal,password,roles){return roles=roles||[],withCommand("add principal "+quoteAndEscape(requireNonNull(principal,"principal"))+" "+quoteAndEscape(requireNonNull(password,"password"))+(roles.length?" "+rolesToString(roles):""))},this.setPassword=function(principal,password){return withCommand("set password "+quoteAndEscape(requireNonNull(principal,"principal"))+" "+quoteAndEscape(requireNonNull(password,"password")))},this.verifyPassword=function(principal,password){return withCommand("verify password "+quoteAndEscape(requireNonNull(principal,"principal"))+" "+quoteAndEscape(requireNonNull(password,"password")))},this.removePrincipal=function(principal){return withCommand("remove principal "+quoteAndEscape(requireNonNull(principal,"principal")))},this.allowAnonymousConnections=function(roles){return roles=roles||[],withCommand("allow anonymous connections "+rolesToString(roles))},this.denyAnonymousConnections=function(){return withCommand("deny anonymous connections")},this.abstainAnonymousConnections=function(){return withCommand("abstain anonymous connections")}}),Security=implements(api.Security,function(internal){this.getSystemAuthentication=function(cb){var emitter=cb?cb instanceof Function?new Emitter("complete",cb):new Emitter(cb):new Emitter,result=new Result(emitter),reference=internal.getServiceLocator().obtain(GET_SYSTEM_AUTHENTICATION);return reference.send(null,function(err,response){err?emitter.error(err):emitter.emit("complete",response)}),result},this.updateSystemAuthentication=function(script,cb){requireNonNull(script,"script");var emitter=cb?cb instanceof Function?new Emitter("complete",cb):new Emitter(cb):new Emitter,result=new Result(emitter);if(""===script)emitter.emit("complete");else{var reference=internal.getServiceLocator().obtain(UPDATE_SYSTEM_AUTHENTICATION);reference.send(new SecurityCommandScript(script),function(err,result){err?emitter.error(err):result.errors.length>0?emitter.emit("rejected",result.errors):emitter.emit("complete")})}return result},this.createScriptBuilder=function(script){return new ScriptBuilder(script)}});module.exports.Security=Security,module.exports.ErrorReport=ErrorReport,module.exports.ScriptBuilder=ScriptBuilder,module.exports.Configuration=Configuration,module.exports.SystemPrincipal=SystemPrincipal},{"../../../features/security":20,"events/emitter":50,"events/result":51,"services/authentication/security-command-script":83,"services/authentication/security-command-script-result":81,"services/services":95,"util/interface":125,"util/logger":126,"util/require-non-null":129}],25:[function(_dereq_,module){var implements=_dereq_("util/interface")["implements"],Services=_dereq_("services/services"),Emitter=_dereq_("events/emitter"),Result=_dereq_("events/result"),AddResult=_dereq_("services/add-topic/add-topic-failure-reason"),WillResult=_dereq_("services/wills/will-registration-result"),WillParams=_dereq_("services/wills/topic-will-parameters"),api=_dereq_("../../../features/topic-control"),util=_dereq_("metadata/util");module.exports=implements(api.TopicControl,function(internal){var serviceLocator=internal.getServiceLocator(),ADD_SERVICE=serviceLocator.obtain(Services.ADD_TOPIC),REMOVE_SERVICE=serviceLocator.obtain(Services.REMOVE_TOPIC),UPDATE_SERVICE=serviceLocator.obtain(Services.TOPIC_UPDATE),TOPIC_WILL_REGISTRATION=serviceLocator.obtain(Services.TOPIC_SCOPED_WILL_REGISTRATION),TOPIC_WILL_DEREGISTRATION=serviceLocator.obtain(Services.TOPIC_SCOPED_WILL_DEREGISTRATION);this.add=function(path,meta){meta=util.deriveMetadata(meta);var emitter=new Emitter,result=new Result(emitter);return ADD_SERVICE.send({path:path,details:meta},function(err,result){if(err)emitter.error(err);else switch(result.status){case 0:case 1:emitter.emit("complete",path,!0);break;case 2:result.reason===AddResult.EXISTS?emitter.emit("complete",path,!1):emitter.error(result.reason);break;case 3:emitter.error({id:0,reason:"Cache failure"})}}),result},this.remove=function(path){var emitter=new Emitter,result=new Result(emitter);return REMOVE_SERVICE.send({topic_name:path},function(error){error?emitter.error(error):emitter.emit("complete")}),result},this.removeWithSession=function(path){var emitter=new Emitter,result=new Result(emitter),params=new WillParams(path,WillParams.Will.REMOVE_TOPICS);return TOPIC_WILL_REGISTRATION.send(params,function(err,result){if(err)emitter.error(err);else if(result===WillResult.SUCCESS){var registered=!0,dEmitter=new Emitter,dResult=new Result(dEmitter),deregister=function(){return registered&&TOPIC_WILL_DEREGISTRATION.send(params,function(err){err?dEmitter.error(err):(registered=!1,dEmitter.emit("complete"))}),dResult};emitter.emit("complete",deregister)}else emitter.error(new Error("REGISTRATION_CONFLICT"))}),result},this.update=function(path,content){var emitter=new Emitter,result=new Result(emitter);return UPDATE_SERVICE.send({topic_path:path,content:content},function(error,result){error?emitter.error(new Error("UNKNOWN_ERROR")):result.isError?emitter.error(new Error(result.reason)):emitter.emit("complete",path)}),result}})},{"../../../features/topic-control":21,"events/emitter":50,"events/result":51,"metadata/util":66,"services/add-topic/add-topic-failure-reason":75,"services/services":95,"services/wills/topic-will-parameters":103,"services/wills/will-registration-result":105,"util/interface":125}],26:[function(_dereq_,module){var HashMap=_dereq_("hashmap").HashMap,implements=_dereq_("util/interface")["implements"],Subscription=(_dereq_("util").inspect,_dereq_("events/subscription")),Emitter=_dereq_("events/emitter"),View=(_dereq_("events/result"),_dereq_("events/view")),Services=_dereq_("services/services"),topicSelectorParser=_dereq_("topics/topic-selector-parser"),Topics=(_dereq_("services/serialisers"),_dereq_("../../../features/topics")),arrays=_dereq_("util/array");module.exports=implements(Topics,function(internal){var subscriptions=[],dispatcher=(new HashMap,function(evt,field){return function(msg){subscriptions.forEach(function(sub){sub.sub.selector.selects(msg.topic)&&sub.emitter.emit(evt,msg[field],msg.topic)})}});internal.getRouting().on({update:dispatcher("update","content"),subscribed:dispatcher("subscribed","details"),unsubscribed:dispatcher("unsubscribed","reason")});{var subscribe=internal.getServiceLocator().obtain(Services.SUBSCRIBE),unsubscribe=internal.getServiceLocator().obtain(Services.UNSUBSCRIBE);internal.getServiceLocator().obtain(Services.GET_TOPIC_DETAILS)}this.subscribe=function(topic,callback){var selector=topicSelectorParser(topic),e=new Emitter,s=new Subscription(e,selector),ref={emitter:e,sub:s};return subscribe.send(selector),s.on("close",function(){arrays.remove(subscriptions,ref)}),callback&&s.on("update",callback),subscriptions.push(ref),s},this.unsubscribe=function(topic){unsubscribe.send(topicSelectorParser(topic))},this.view=function(selector,callback){var s=this.subscribe(selector);return new View(s,callback)}})},{"../../../features/topics":22,"events/emitter":50,"events/result":51,"events/subscription":53,"events/view":54,hashmap:9,"services/serialisers":94,"services/services":95,"topics/topic-selector-parser":118,util:8,"util/array":122,"util/interface":125}],27:[function(_dereq_,module){var serialiser={read:function(bis,enums){var k,i=bis.read();for(k in enums){var e=enums[k];if(e===i||void 0!==e.id&&e.id===i)return e}throw new Error("Unable to decode enum value "+i)
},write:function(bos,val){bos.write(val.id?val.id:val)}};module.exports=serialiser},{}],28:[function(_dereq_,module){var service={onRequest:function(internal,request,callback){callback.respond(),internal.getRouting().subscribed(request.info)}};module.exports=service},{}],29:[function(_dereq_,module){var service={onRequest:function(internal,notification,callback){callback.respond(),internal.getRouting().unsubscribed(notification.id,notification.reason)}};module.exports=service},{}],30:[function(_dereq_,module){var service={onRequest:function(internal,ping,callback){callback.respond()}};module.exports=service},{}],31:[function(_dereq_,module){module.exports={COMMUNICATION_FAILURE:{id:100,reason:"Communication with server failed"},SESSION_CLOSED:{id:101,reason:"Session is closed"},REQUEST_TIME_OUT:{id:102,reason:"Request time out"},ACCESS_DENIED:{id:103,reason:"Access denied"},TOPIC_TREE_REGISTRATION_CONFLICT:{id:200,reason:"A conflicting, pre-existing registration exists on the same branch of the topic tree"}}},{}],32:[function(_dereq_,module){function InternalSession(conversationSet,serviceRegistry,connectionFactory){function close(reason){fsm.change("closed")?(conversationSet.discardAll(reason),emitter.close(reason)):log.debug("Unable to handle session close, session state: ",fsm.state)}var emitter=Emitter.assign(this),fsm=FSM.create("initialising",{initialising:["connecting"],connecting:["connected","closing"],connected:["disconnected","closing"],disconnected:["reconnecting","closing"],reconnecting:["connected","closing"],closing:["closed"],closed:[]});fsm.on("change",function(previous,current){log.info("State changed: "+previous+" -> "+current)}),this.getConversationSet=function(){return conversationSet},this.isConnected=function(){return"connected"===fsm.state};var connection=connectionFactory.create(Aliases.create(),Transports.create()),serviceAdapter=new ServiceAdapter(this,serialisers,connection.send),serviceLocator=new ServiceLocator(this,serialisers,serviceAdapter),routing=new TopicRouting(serviceAdapter);serviceRegistry.addListener(serviceAdapter.addService);var sessionID,principal,token,attempts=0,reconnect=function(opts){if(fsm.change("reconnecting")){log.info("Reconnect attempt ("+ ++attempts+")");var request=ConnectionRequest.reconnect(token);connection.connect(request,opts)}else log.debug("Unable to attempt reconnect, session state: ",fsm.state)},abort=function(reason){fsm.change("closing")?(log.debug("Aborting reconnect"),close(reason||CloseReason.RECONNECT_ABORTED)):log.debug("Unable to abort reconnect, session state: ",fsm.state)};this.connect=function(opts){if(fsm.change("connecting")){var request=ConnectionRequest.connect(),strategy=reconnectStrategy(opts,reconnect,abort);connection.on("data",routing.route),connection.on("close",close),connection.on("disconnect",function(reason){log.debug("Connection disconnected, reason: ",reason),fsm.change("disconnected")||"reconnecting"===fsm.state?opts.reconnect&&reason.canReconnect?("disconnected"===fsm.state&&emitter.emit("disconnect",reason),strategy(reason)):abort(reason):fsm.change("closing")?close(reason):log.debug("Unable to handle session disconnect, session state: ",fsm.state)}),connection.on("connect",function(response){fsm.change("connected")?response.response===ResponseCode.OK?(sessionID=response.identity,token=response.token,log.info("Connected, session id: ",response.identity.toString()),emitter.emit("connect",response.identity)):response.response===ResponseCode.RECONNECTED&&(log.info("Reconnected session"),emitter.emit("reconnect")):log.debug("Unknown connection response: ",response)}),log.info("Connecting with options:",opts),log.debug("Connecting with request:",request);try{connection.connect(request,opts)}catch(e){log.warn("Connection error",e),emitter.emit("error",e),fsm.change("closing")&&close(CloseReason.CONNECTION_ERROR)}principal=opts.credentials?opts.credentials.principal:""}else log.warn("Unable to connect, session state: ",fsm.state),emitter.emit("error",new Error("Unable to connect, session state: "+fsm.state))},this.close=function(){fsm.change("closing")?connection.close(CloseReason.CLOSED_BY_CLIENT):log.debug("Unable to close, session state: ",fsm.state)},this.getServiceLocator=function(){return serviceLocator},this.getServiceAdapter=function(){return serviceAdapter},this.getPrincipal=function(){return principal},this.getRouting=function(){return routing}}var Emitter=_dereq_("events/emitter"),reconnectStrategy=_dereq_("client/reconnect-strategy"),ServiceAdapter=_dereq_("client/service-adapter"),ServiceLocator=_dereq_("client/service-locator"),TopicRouting=_dereq_("client/routing"),serialisers=_dereq_("services/serialisers"),ConnectionRequest=_dereq_("protocol/connection-request"),ResponseCode=_dereq_("protocol/response-code"),CloseReason=_dereq_("v4-stack/close-reason"),Transports=_dereq_("transports/transports"),Aliases=_dereq_("v4-stack/aliases"),log=_dereq_("util/logger").create("Internal Session"),FSM=(_dereq_("../../options"),_dereq_("util/function").curry,_dereq_("util/fsm"));module.exports=InternalSession},{"../../options":137,"client/reconnect-strategy":33,"client/routing":34,"client/service-adapter":35,"client/service-locator":36,"events/emitter":50,"protocol/connection-request":67,"protocol/response-code":70,"services/serialisers":94,"transports/transports":120,"util/fsm":123,"util/function":124,"util/logger":126,"v4-stack/aliases":131,"v4-stack/close-reason":132}],33:[function(_dereq_,module){function createStrategy(opts,connect,close){return opts.reconnect?"function"==typeof opts.reconnect?curry(opts.reconnect,curry(connect,opts),close):curry(setTimeout,curry(connect,opts),5e3):curry(close,CloseReason.RECONNECT_ABORTED)}var CloseReason=_dereq_("v4-stack/close-reason"),curry=_dereq_("util/function").curry;module.exports=createStrategy},{"util/function":124,"v4-stack/close-reason":132}],34:[function(_dereq_,module){function Routing(serviceAdapter){function update(message){emitter.emit("update",{topic:message.topic,content:message.data})}var emitter=Emitter.assign(this),topicToInfo={},idToInfo={};this.route=function(message){message.isTopicMessage()?"@"===message.topic?serviceAdapter.onMessage(message.getInputStream()):update(message):log.debug("V4 Message: "+message.type,message)},this.subscribed=function(info){void 0===idToInfo[info.id]&&(idToInfo[info.id]=info),void 0===topicToInfo[info.path]&&(topicToInfo[info.path]=info),emitter.emit("subscribed",{topic:info.path,details:info.details})},this.unsubscribed=function(id,reason){var info=idToInfo[id];info&&(topicToInfo[info.path]=null,idToInfo[id]=null,emitter.emit("unsubscribed",{topic:info.path,reason:reason}))}}var Emitter=_dereq_("events/emitter"),log=_dereq_("util/logger").create("V4 Client Routing");module.exports=Routing},{"events/emitter":50,"util/logger":126}],35:[function(_dereq_,module){function ServiceAdapter(internalSession,serialisers,sender){function sendMessage(header,command,serialiser){var msg=Message.create({type:Message.types.DELTA,topic:"@"});headerSerialiser.write(msg,header),serialiser.write(msg,command),log.debug("Sending command message to server: ",header.toString()),sender(msg)}function handleRequest(header,input){var listener=listeners[header.service];if(listener)listener(header,input);else{var error=new CommandError(type.COMMUNICATION_FAILURE,"Unknown client service: "+header.service);sendMessage(header.createErrorHeader(),error,errorSerialiser)}}function handleResponse(header,input){conversations.respond(header.cid,input)}function handleError(header,input){var error=errorSerialiser.read(input);log.warn("Command Error received",error.message),conversations.discard(header.cid,new Error(error.message))}var headerSerialiser=serialisers.get(CommandHeader),errorSerialiser=serialisers.get(CommandError),conversations=internalSession.getConversationSet(),listeners={};this.send=sendMessage,this.addService=function(definition,service){if(void 0!==listeners[definition.id])throw new Error("Service already exists for "+definition);var requestSerialiser=serialisers.get(definition.request),responseSerialiser=serialisers.get(definition.response);listeners[definition.id]=function(header,input){var request=requestSerialiser.read(input),callback={respond:function(response){var rHeader=header.createResponseHeader();sendMessage(rHeader,response,responseSerialiser)},fail:function(error){var eHeader=header.createErrorHeader();sendMessage(eHeader,error,errorSerialiser)}};try{service.onRequest(internalSession,request,callback)}catch(e){throw new Error("Unable to handle request for "+definition.id,e)}}},this.onMessage=function(data){var header=headerSerialiser.read(data);switch(log.debug("Received command message from server: ",header.toString()),header.mode){case mode.REQUEST:handleRequest(header,data);break;case mode.RESPONSE:handleResponse(header,data);break;case mode.ERROR:handleError(header,data);break;default:throw new Error("Unknown Command Header mode"+header.mode)}}}var CommandHeader=_dereq_("services/command-header"),CommandError=_dereq_("services/command-error"),Message=_dereq_("v4-stack/message"),mode=CommandHeader.modes,type=CommandError.ErrorType,log=_dereq_("util/logger").create("Service Adapter");module.exports=ServiceAdapter},{"services/command-error":87,"services/command-header":89,"util/logger":126,"v4-stack/message":136}],36:[function(_dereq_,module){function ServiceLocator(internalSession,serialisers,serviceAdapter){var conversations=internalSession.getConversationSet();this.obtain=function(service){var pending=[],requestSerialiser=serialisers.get(service.request),responseSerialiser=serialisers.get(service.response),reference={send:function(req,callback){callback=callback||defaultCB;var handler={onOpen:function(cid){var header=new CommandHeader(mode.REQUEST,service.id,cid);serviceAdapter.send(header,req,requestSerialiser),pending.push(cid)},onResponse:function(cid,input){try{callback(null,responseSerialiser.read(input))}catch(e){log.debug("Error handling service response",e),callback(e)}return remove(pending,cid),!0},onDiscard:function(cid,err){try{callback(err)}catch(e){log.debug("Error discard service callback",e)}remove(pending,cid)}},cid=conversations["new"](handler);return function(){conversations.discard(cid,"cancelled")}},close:function(){pending.forEach(conversations.discard),pending=[]}};return reference}}var CommandHeader=_dereq_("services/command-header"),mode=CommandHeader.prototype.mode,log=_dereq_("util/logger").create("Service Locator"),remove=function(arr,e){var i=arr.indexOf(e);i>-1&&arr.splice(i,1)},defaultCB=function(){};module.exports=ServiceLocator},{"services/command-header":89,"util/logger":126}],37:[function(_dereq_,module){function ServiceRegistry(){var services=new HashMap,listeners=[];this.get=function(definition){return services.get(definition)},this.add=function(definition,service){if(services.has(definition))throw new Error("Service already exists for "+definition);services.set(definition,service),listeners.forEach(function(listener){listener(definition,service)})},this.addListener=function(listener){listeners.push(listener),services.forEach(function(k,v){listener(v,k)})}}var HashMap=_dereq_("hashmap").HashMap;module.exports=ServiceRegistry},{hashmap:9}],38:[function(_dereq_,module){module.exports={RECORD_DELIMITER:1,FIELD_DELIMITER:2,RECORD_MU:4,FIELD_MU:5}},{}],39:[function(_dereq_,module){var BufferInputStream=_dereq_("io/buffer-input-stream"),RecordContent=_dereq_("./record-content"),consts=_dereq_("content/consts");module.exports=function(buffer){var records=[];if(1===buffer.length&&buffer[0]===consts.RECORD_MU)records.push(new RecordContent.Record([]));else if(buffer.length>0){for(var bis=new BufferInputStream(buffer);bis.hasRemaining();){for(var rbis=new BufferInputStream(bis.readUntil(consts.RECORD_DELIMITER)),fields=[];rbis.hasRemaining();){var field=rbis.readUntil(consts.FIELD_DELIMITER);fields.push(0===fields.length&&1===field.length&&field[0]===consts.FIELD_MU?"":field.toString())}records.push(new RecordContent.Record(fields))}buffer[buffer.length-1]===consts.RECORD_DELIMITER&&records.push(new RecordContent.Record([]))}return new RecordContent(records)}},{"./record-content":40,"content/consts":38,"io/buffer-input-stream":55}],40:[function(_dereq_,module){var consts=_dereq_("content/consts"),RecordContent=function(records){this.length=records.length,this.get=function(i){return i=i||0,records[i]},this.records=function(){return records.concat([])},this.forEach=function(iterator){records.forEach(iterator)},this.toString=function(){return records.join(consts.RECORD_DELIMITER)}};RecordContent.Record=function(fields){this.length=fields.length,this.get=function(i){return i=i||0,fields[i]},this.fields=function(){return fields.concat([])},this.forEach=function(iterator){fields.forEach(iterator)},this.toString=function(){return fields.join(consts.FIELD_DELIMITER)}},module.exports=RecordContent},{"content/consts":38}],41:[function(_dereq_,module){var BEES=_dereq_("api/serialisers/byte-encoded-enum-serialiser"),Codec=_dereq_("io/codec"),util=_dereq_("content/util"),Encoding={NONE:0,ENCRYPTED:1,COMPRESSED:2};module.exports={read:function(bis){var encoding=BEES.read(Encoding,bis),bytes=Codec.readBytes(bis);switch(encoding){case Encoding.NONE:return bytes;default:throw new Error("Unable to handle encoding type "+encoding)}},write:function(bos,content){BEES.write(bos,Encoding.NONE),Codec.writeBytes(bos,util.getBytes(content))}}},{"api/serialisers/byte-encoded-enum-serialiser":27,"content/util":45,"io/codec":57}],42:[function(_dereq_,module){function insertFields(record,fn,fields){if(fields)for(var field in fields){var value=fields[field];if(value instanceof Array)for(var i=0;i<value.length;++i)fn.call(record,field,value[i],i);else fn.call(record,field,value)}}var implements=_dereq_("util/interface")["implements"],api=_dereq_("../../../content/record-content"),RecordContent=_dereq_("content/structured-record-content/record-content"),RecordRecordBuilder=implements(api.Builder.Record,function(meta){var fields={};this.add=function(name,value){var mfield=meta.getField(name);if(!mfield)throw new Error("Invalid field name  '"+name+"'");if(void 0===fields[name]&&(fields[name]=[]),!(fields[name].length<mfield.occurs.max))throw new Error("Field '"+name+"' can only occur up to "+mfield.occurs.max+" times");return fields[name].push(value),this},this.set=function(name,value,index){var mfield=meta.getField(name);if(!mfield)throw new Error("Invalid field name '"+name+"'");if(void 0===fields[name]&&(fields[name]=[]),mfield.occurs.min===mfield.occurs.max)fields[name][0]=value;else{if(void 0===index||void 0===fields[name][index])throw new Error("Invalid index for field '"+name+'" ('+index+")");fields[name][index]=value}return this},this.build=function(){var $fields={};return meta.getFields().forEach(function(mfield){var field=mfield.name;$fields[field]=[],void 0===fields[field]&&(fields[field]=[]);for(var i=fields[field].length;i<mfield.occurs.min;++i)fields[field].push(mfield.type.value);$fields[field]=fields[field]}),new RecordContent.Record($fields)}}),RecordBuilder=implements(api.Builder,function(meta){var records={};this.add=function(name,fields){var mrecord=meta.getRecord(name);if(mrecord){if(void 0===records[name]&&(records[name]=[]),records[name].length<mrecord.occurs.max){var record=new RecordRecordBuilder(mrecord);return records[name].push(record),insertFields(record,record.add,fields),record}throw new Error("Record '"+name+"' can only occur up to "+mrecord.occurs.max+" times")}throw new Error("Invalid record name '"+name+"'")},this.set=function(name,fields,index){var mrecord=meta.getRecord(name);if(!mrecord)throw new Error("Invalid record name '"+name+"'");void 0===records[name]&&(records[name]=[]);var record;if(mrecord.occurs.min===mrecord.occurs.max)void 0===records[name][0]&&(record=new RecordRecordBuilder(mrecord),records[name].push(record));else{if(void 0===index||void 0===fields[name][index])throw new Error("Invalid index for record '"+name+'" ('+index+")");record=records[name][index]}insertFields(record,record.set,fields)},this.build=function(){var $records={};return meta.getRecords().forEach(function(mrecord){var record=mrecord.name;$records[record]=[],void 0===records[record]&&(records[record]=[]);for(var i=records[record].length;i<mrecord.occurs.min;++i)records[record].push(new RecordRecordBuilder(mrecord));for(var j=0;j<records[record].length;++j)$records[record].push(records[record][j].build())}),new RecordContent($records)}});module.exports=RecordBuilder},{"../../../content/record-content":14,"content/structured-record-content/record-content":44,"util/interface":125}],43:[function(_dereq_,module){function Reader(set){var pos=0;this.readUpTo=function(occurs,fn){var max=Math.min(pos+(-1===occurs.max?set.length:occurs.max),set.length);if(0!==set.length){if(occurs.min>set.length-pos)throw new Error("Data exhaused while parsing");for(var i=pos;max>i;++i)fn(set[i]);pos=max}}}function RecordContentMetadataParser(metadata){this.parse=function(buffer){var content=parseAsRecordContent(buffer),reader=new Reader(content.records()),$records={};return metadata.getRecords().forEach(function(mrecord){var records=[];reader.readUpTo(mrecord.occurs,function(record){var reader=new Reader(record.fields()),$fields={};mrecord.getFields().forEach(function(mfield){var fields=[];reader.readUpTo(mfield.occurs,function(field){fields.push(mfield.type.parse(field))}),$fields[mfield.name]=fields}),records.push(new RecordContent.Record($fields))}),$records[mrecord.name]=records}),new RecordContent($records)}}var parseAsRecordContent=_dereq_("content/record-content/parser"),RecordContent=_dereq_("content/structured-record-content/record-content");module.exports=RecordContentMetadataParser},{"content/record-content/parser":39,"content/structured-record-content/record-content":44}],44:[function(_dereq_,module){var implements=_dereq_("util/interface")["implements"],api=_dereq_("../../../content/record-content"),StructuredRecordContent=implements(api,function(records){var inlined=[];for(var k in records)inlined=inlined.concat(records[k]);this.get=function(name,index){return index=index||0,records[name]?records[name][index]:void 0},this.records=function(name){return records[name]?records[name].concat([]):inlined.concat([])},this.forEach=function(iterator){inlined.forEach(iterator)}});StructuredRecordContent.Record=implements(api.Record,function(fields){var inlined=[];for(var k in fields)inlined=inlined.concat(fields[k]);this.get=function(name,index){return index=index||0,fields[name]?fields[name][index]:void 0},this.fields=function(name){return fields[name]?fields[name].concat([]):inlined.concat([])},this.forEach=function(iterator){inlined.forEach(iterator)}}),module.exports=StructuredRecordContent},{"../../../content/record-content":14,"util/interface":125}],45:[function(_dereq_,module){(function(Buffer){function getDefaultContentBytes(content){return new Buffer(content.toString())}function getRecordContentBytes(content){var bos=new BufferOutputStream,recordDelimiter=!1;return content.forEach(function(r){var fieldDelimiter=!1;recordDelimiter?bos.writeInt8(consts.RECORD_DELIMITER):recordDelimiter=!0,r.forEach(function(f){fieldDelimiter?bos.writeInt8(consts.FIELD_DELIMITER):fieldDelimiter=!0,bos.writeString(f.toString())})}),bos.getBuffer()}function isRecordContent(content){return RC.isPrototypeOf(content)||SRC.isPrototypeOf(content)}function getBytes(content){return isRecordContent(content)?getRecordContentBytes(content):getDefaultContentBytes(content)}var BufferOutputStream=(_dereq_("io/codec"),_dereq_("io/buffer-output-stream")),RC=_dereq_("content/record-content/record-content"),SRC=_dereq_("content/structured-record-content/record-content"),consts=_dereq_("content/consts");module.exports={getBytes:getBytes,isRecordContent:isRecordContent}}).call(this,_dereq_("buffer").Buffer)},{buffer:2,"content/consts":38,"content/record-content/record-content":40,"content/structured-record-content/record-content":44,"io/buffer-output-stream":56,"io/codec":57}],46:[function(_dereq_,module){var Codec=_dereq_("io/codec"),ConversationId=_dereq_("conversation/conversation-id"),CIDSerialiser={read:function(input){return new ConversationId(Codec.readInt64(input))},write:function(out,cid){Codec.writeInt64(out,cid.val)}};module.exports=CIDSerialiser},{"conversation/conversation-id":47,"io/codec":57}],47:[function(_dereq_,module){function ConversationId(val){this.val=val}var Long=_dereq_("long");ConversationId.prototype.toString=function(){return this.val.toString(10)},ConversationId.prototype.toValue=function(){return this.toString()},ConversationId.fromString=function(val){return new ConversationId(Long.fromString(val,!1))},module.exports=ConversationId},{"long":13}],48:[function(_dereq_,module){function create(error){var conversations=new HashMap,bulkhead=function(set,handler,fn){return function(cid){try{return fn.apply(handler,slice.call(arguments,0))}catch(e){return set.discard(cid),void error(cid,e)}}};return{"new":function(handler){var cid=nextCID(),set=this,conversation=new Conversation({onOpen:bulkhead(set,handler,handler.onOpen),onResponse:bulkhead(set,handler,handler.onResponse),onDiscard:bulkhead(set,handler,handler.onDiscard)});return conversations.set(cid.toString(),conversation),conversation.open(cid),cid},respond:function(cid,r1,r2){var conversation=conversations.get(cid.toString()),response="NON_EXISTENT";switch(conversation&&(response=conversation.respond(cid,r1,r2)),response){case"NON_EXISTENT":error(cid,response);break;case"ALREADY_FINISHED":error(cid,response);break;case"HANDLED_AND_ACTIVE":break;case"HANDLED_AND_FINISHED":conversations.remove(cid.toString())}},discard:function(cid,err){var conversation=conversations.get(cid.toString());conversation&&conversations.remove(cid.toString()),conversation.discard(cid,err)},discardAll:function(err){conversations.forEach(function(conversation,cid){conversation.discard(ConversationId.fromString(cid),err)}),conversations.clear()},size:function(){return conversations.count()}}}var HashMap=_dereq_("hashmap").HashMap,Long=_dereq_("long"),ConversationId=_dereq_("conversation/conversation-id"),Conversation=_dereq_("conversation/conversation"),slice=Array.prototype.slice,nextCID=function(){var id=new Long(0);return function(){return id=id.add(1),new ConversationId(id)}}();module.exports=create},{"conversation/conversation":49,"conversation/conversation-id":47,hashmap:9,"long":13}],49:[function(_dereq_,module){function Conversation(handler){this.handler=handler}Conversation.prototype.open=function(cid){this.handler.onOpen(cid)},Conversation.prototype.respond=function(cid,r1,r2){var close=void 0===r2?this.handler.onResponse(cid,r1):this.handler.onResponse(cid,r1,r2);return close?"HANDLED_AND_FINISHED":"HANDLED_AND_ACTIVE"},Conversation.prototype.discard=function(cid,err){this.handler.onDiscard(cid,err)},module.exports=Conversation},{}],50:[function(_dereq_,module){(function(process){function Emitter(e,fn){var listeners={},listener=function(){},closed=!1,emit=function(event,args){if(args=args||[],listeners[event]){var dispatch=function(listener){functions.callWithArguments(listener,args)};process.nextTick(function(){listeners[event].forEach(dispatch)})}listener(event,args)},__emit=function(event){if(!closed&&event){var args=array.argumentsToArray(arguments);args.shift(),emit(event,args)}},error=function(reason){emit("error",[reason]),close()},close=function(reason){closed||(closed=!0,emit("close",[reason]))},stream=new Stream(listeners,error,close);stream.on(e,fn),this.listen=function(fn){listener=fn},this.get=function(){return stream},this.close=close,this.error=error,this.emit=__emit}var functions=_dereq_("util/function"),array=_dereq_("util/array"),Stream=_dereq_("events/stream");Emitter.assign=function(instance){var emitter=new Emitter,s=emitter.get();for(var k in s)instance[k]=s[k];return emitter},module.exports=Emitter}).call(this,_dereq_("Zbi7gb"))},{Zbi7gb:6,"events/stream":52,"util/array":122,"util/function":124}],51:[function(_dereq_,module){(function(process){function ResultImpl(emitter){function dispatchOnBind(e,fn){void 0!==cache[e]&&process.nextTick(function(){functions.callWithArguments(fn,cache[e])})}var stream=emitter.get(),cache={};emitter.listen(function(e,args){cache[e]=args,emitter.close()});for(var fn in stream)this[fn]=stream[fn];var on=this.on;this.on=function(event,cb){if(on(event,cb),event instanceof Object)for(var k in event)dispatchOnBind(k,event[k]);else dispatchOnBind(event,cb);return this}}var implements=_dereq_("util/interface")["implements"],functions=_dereq_("util/function"),Result=_dereq_("../../events/result");module.exports=implements(Result,ResultImpl)}).call(this,_dereq_("Zbi7gb"))},{"../../events/result":16,Zbi7gb:6,"util/function":124,"util/interface":125}],52:[function(_dereq_,module){function attach(object,key,value){if("object"==typeof key)for(var k in key)attach(object,k,key[k]);else value&&(void 0===object[key]&&(object[key]=[]),object[key].push(value));return object}function remove(object,key,value){if("object"==typeof key)for(var k in key)remove(object,k,key[k]);else object[key]&&(object[key]=value?object[key].filter(function(e){return e!==value}):[]);return object}function StreamImpl(listeners,error,close){this.on=function(event,fn){return attach(listeners,event,fn),this},this.off=function(event,fn){return remove(listeners,event,fn),this},this.close=function(reason){return close(reason),this},this.error=function(reason){return error(reason),this}}var implements=_dereq_("util/interface")["implements"],Stream=_dereq_("../../events/stream");module.exports=implements(Stream,StreamImpl)},{"../../events/stream":17,"util/interface":125}],53:[function(_dereq_,module){function SubscriptionImpl(emitter,selector){var stream=emitter.get();for(var fn in stream)this[fn]=stream[fn];this.selector=selector,this.view=function(){return new View(this)},this.transform=function(fn){var e=new Emitter;return fn=util.isMetadata(fn)?fn.parse.bind(fn):fn,stream.on("update",function(update,topic){e.emit("update",fn(update),topic)}),stream.on("subscription",function(details){e.emit("subscription",details)}),stream.on("unsubscription",function(reason){e.emit("unsubscription",reason)}),new SubscriptionImpl(e,selector)}}var implements=_dereq_("util/interface")["implements"],Subscription=_dereq_("../../events/subscription"),Emitter=_dereq_("events/emitter"),View=_dereq_("events/view"),util=_dereq_("metadata/util");module.exports=implements(Subscription,SubscriptionImpl)},{"../../events/subscription":18,"events/emitter":50,"events/view":54,"metadata/util":66,"util/interface":125}],54:[function(_dereq_,module){function ViewImpl(subscription){var emitter=Emitter.assign(this),data={};subscription.on("update",function(value,topic){for(var parts=topic.split("/"),child=data,i=0;i<parts.length-1;i++)void 0===child[parts[i]]&&(child[parts[i]]={}),child=child[parts[i]];child[parts[i]]=value,emitter.emit("update",data)}),subscription.on("close",emitter.close),this.get=function(){return data}}var implements=_dereq_("util/interface")["implements"],Emitter=_dereq_("events/emitter"),View=_dereq_("../../events/view");module.exports=implements(View,ViewImpl)},{"../../events/view":19,"events/emitter":50,"util/interface":125}],55:[function(_dereq_,module){function BufferInputStream(buffer){if(null===buffer||void 0===buffer)throw new Error("Undefined buffer for InputStream");this.buffer=buffer,this.count=buffer.length,this.mark=0,this.pos=0}var Long=_dereq_("long");BufferInputStream.prototype.read=function(){return this.pos<this.count?255&this.buffer[this.pos++]:-1},BufferInputStream.prototype.readMany=function(length){if(length=Math.min(length,this.count-this.pos),0>length)throw new Error("Length out of bounds");var buffer=this.buffer.slice(this.pos,this.pos+length);return this.pos+=length,buffer},BufferInputStream.prototype.readUntil=function(delim){for(var found=this.count,i=this.pos;i<this.count;i++)if(this.buffer[i]===delim){found=i;break}var buffer=this.buffer.slice(this.pos,found);return this.pos=found+1,buffer},BufferInputStream.prototype.readInt8=function(){return this.buffer.readInt8(this.pos++)},BufferInputStream.prototype.readInt32=function(){var i=this.buffer.readInt32BE(this.pos);return this.pos+=4,i},BufferInputStream.prototype.readInt64=function(){var hi=this.buffer.readInt32BE(this.pos);this.pos+=4;var lo=this.buffer.readInt32BE(this.pos);return this.pos+=4,Long.fromBits(lo,hi,!1)},BufferInputStream.prototype.readUInt64=function(){var hi=this.buffer.readInt32BE(this.pos);this.pos+=4;var lo=this.buffer.readInt32BE(this.pos);return this.pos+=4,Long.fromBits(lo,hi,!0)},BufferInputStream.prototype.hasRemaining=function(){return this.pos<this.buffer.length},module.exports=BufferInputStream},{"long":13}],56:[function(_dereq_,module){(function(Buffer){function ensureCapacity(bos,min){min-bos.buffer.length>0&&grow(bos,min)}function grow(bos,minCapacity){var oldCapacity=bos.buffer.length,newCapacity=oldCapacity<<1;0>newCapacity-minCapacity&&(newCapacity=minCapacity);try{var replacement=new Buffer(newCapacity);bos.buffer.copy(replacement),bos.buffer=replacement}catch(e){throw new Error("Unable to resize BufferOutputStream to "+newCapacity)}}function BufferOutputStream(initial){initial instanceof Buffer?(this.buffer=initial,this.count=initial.length):(this.buffer=new Buffer(initial||32),this.count=0)}BufferOutputStream.prototype.write=function(val){ensureCapacity(this,this.count+1),this.buffer[this.count++]=val},BufferOutputStream.prototype.writeMany=function(buffer){ensureCapacity(this,this.count+buffer.length),buffer.copy(this.buffer,this.count),this.count+=buffer.length},BufferOutputStream.prototype.writeString=function(val){var length=Buffer.byteLength(val);ensureCapacity(this,this.count+length),this.buffer.write(val,this.count,length),this.count+=length},BufferOutputStream.prototype.writeInt8=function(val){ensureCapacity(this,this.count+1),this.buffer.writeInt8(val,this.count++)},BufferOutputStream.prototype.writeInt32=function(val){ensureCapacity(this,this.count+4),this.buffer.writeInt32BE(val,this.count),this.count+=4},BufferOutputStream.prototype.writeInt64=function(val){ensureCapacity(this,this.count+8),this.buffer.writeInt32BE(val.getHighBits(),this.count),this.buffer.writeInt32BE(val.getLowBits(),this.count+4),this.count+=8},BufferOutputStream.prototype.getBuffer=function(){return this.buffer.slice(0,this.count)},BufferOutputStream.prototype.getBase64=function(){return this.getBuffer().toString("base64")},module.exports=BufferOutputStream}).call(this,_dereq_("buffer").Buffer)},{buffer:2}],57:[function(_dereq_,module){(function(Buffer){var Long=_dereq_("long"),x80=Long.fromNumber(128),x7F=Long.fromNumber(127),x7FInv=x7F.not(),readOneByte=function(input){var i=input.read();if(-1===i)throw new Error("End of stream");return i},codec={};codec.readInt64=function(input){for(var result=Long.fromNumber(0),shift=0;64>shift;){var i=readOneByte(input),l=Long.fromNumber(i);if(result=result.or(l.and(x7F).shiftLeft(shift)),l.and(x80).equals(0))return result;shift+=7}throw"Malformed int64"},codec.writeInt64=function(bos,value){for(var int64=value instanceof Long?value:Long.fromNumber(value);;){if(int64.and(x7FInv).equals(0))return void bos.write(int64.toInt());bos.write(int64.and(x7F).or(x80).toInt()),int64=int64.shiftRightUnsigned(7)}},codec.readInt32=function(bis){for(var shift=0,result=0;32>shift;){var i=readOneByte(bis);if(result|=(127&i)<<shift,0===(128&i))return result;shift+=7}throw"Malformed int32"},codec.writeInt32=function(bos,value){for(;;){if(0===(-128&value))return void bos.write(value);bos.write(127&value|128),value>>>=7}},codec.writeByte=function(bos,value){bos.writeInt8(value),0!==(-128&value)&&bos.write(1)},codec.readByte=function(bis){var b1=bis.readInt8();if(0===(-128&b1))return b1;var b2=readOneByte(bis);if(1!==b2)throw"Malformed byte";return 128|b1},codec.readBytes=function(bis){var length=codec.readInt32(bis);
return bis.readMany(length)},codec.writeBytes=function(bos,value){codec.writeInt32(bos,value.length),bos.writeMany(value)},codec.readString=function(bis){var buffer=codec.readBytes(bis);return buffer?buffer.toString("utf8"):""},codec.writeString=function(bos,value){codec.writeBytes(bos,new Buffer(value,"utf8"))},codec.writeCollection=function(bos,arr,write){codec.writeInt32(bos,arr.length);for(var i=0;i<arr.length;++i)write(bos,arr[i])},codec.readCollection=function(bis,read){for(var length=codec.readInt32(bis),arr=[],i=0;length>i;++i)arr.push(read(bis));return arr},codec.readBoolean=function(bis){var b=bis.readInt8();return 0===b?!1:!0},codec.writeBoolean=function(bos,value){bos.writeInt8(value?1:0)},module.exports=codec}).call(this,_dereq_("buffer").Buffer)},{buffer:2,"long":13}],58:[function(_dereq_,module){module.exports=function(val,scale){var self=this;if(void 0!==val&&"number"!=typeof val)throw new Error("Decimal metadata must be given a numeric default value");if(void 0!==scale&&"number"!=typeof scale)throw new Error("Decimal metadata must be given a numeric scale");if(this.value=val||0,void 0===scale){var str=this.value+"",i=str.indexOf(".");this.scale=i>-1?str.length-(i+1):2}else this.scale=scale;this.getDetails=function(){return{type:"decimalString",name:"decimalString","default":self.value,scale:self.scale}},this.parse=function(buffer){var str=buffer.toString(),i=str.indexOf(".");return+str.substr(0,i+this.scale+1)}}},{}],59:[function(_dereq_,module){module.exports=function(val){var self=this;if(void 0!==val&&"number"!=typeof val)throw new Error("Integer metadata must be given a numeric default value");this.value=parseInt(val,10)||0,this.getDetails=function(){return{type:"integerString",name:"integerString","default":self.value}},this.parse=function(buffer){return parseInt(buffer.toString(),10)}}},{}],60:[function(_dereq_,module){var MRecordContent=(_dereq_("util/interface")["implements"],_dereq_("../../metadata/metadata"),_dereq_("./record-content")),MStateless=_dereq_("./stateless"),MDecimal=_dereq_("./decimal"),MInteger=_dereq_("./integer"),MString=_dereq_("./string");module.exports={RecordContent:MRecordContent,Stateless:MStateless,Decimal:MDecimal,Integer:MInteger,String:MString}},{"../../metadata/metadata":23,"./decimal":58,"./integer":59,"./record-content":61,"./stateless":62,"./string":63,"util/interface":125}],61:[function(_dereq_,module){function occurs(m,n){var min=1,max=1;if(void 0!==m){if("string"==typeof m){var i=m.indexOf(".");if(-1!==i){var j=m.lastIndexOf(".");min=m.substring(0,i),max=m.substring(j+1),"*"===max&&(max=-1)}else min=m,max=m}else"number"==typeof m?(min=m,max=void 0!==n&&"number"==typeof n?n:m):void 0!==m.min&&(min=m.min,max=m.max);void 0===max&&(max=min),min=parseInt(min,10),max=parseInt(max,10)}return{min:min,max:max,toString:function(){var min=this.min,max=this.max>-1?this.max:"*";return min===max?""+min:min+".."+max}}}var implements=_dereq_("util/interface")["implements"],Metadata=_dereq_("../../metadata/metadata"),RecordContentParser=_dereq_("content/structured-record-content/parser"),RecordContentBuilder=_dereq_("content/structured-record-content/builder"),MDecimal=_dereq_("./decimal"),MInteger=_dereq_("./integer"),MString=_dereq_("./string"),util=_dereq_("./util-single-value"),count=0,MFieldImpl=implements(Metadata.RecordContent.Field,function(name,type,occurs){if(this.name=name,this.occurs=occurs,type){var t=util.deriveMetadata(type);if(util.getType(t)!==util.Type.SINGLE_VALUE)throw new Error("Record fields can only have single values (string, integer or decimal)");this.type=t}else this.type=new MString;this.getDetails=function(){var details=this.type.getDetails();return details.name=name,details.multiplicity=occurs.toString(),details}}),MRecordImpl=implements(Metadata.RecordContent.Record,function(name,m){var fields={},order=[];this.name=name,this.occurs=m,this.getField=function(name){switch(typeof name){case"string":return fields[name];case"number":return fields[order[name]]}return void 0},this.getFields=function(){return order.map(function(name){return fields[name]})},this.addField=function(name,type,m){if(fields[name])throw new Error("Field metadata already exists for: "+name);var previous=fields[order[order.length-1]];if(previous&&previous.occurs.min!==previous.occurs.max)throw new Error("Fields cannot be added after a repeating field");var field=new MFieldImpl(name,type,occurs(m));return fields[name]=field,order.push(name),field},this.getDetails=function(){return{name:name,multiplicity:m.toString()}}}),MRecordContentImpl=implements(Metadata.RecordContent,function(name){var parser=new RecordContentParser(this),self=this,records={},order=[];name=name||"MRecordData"+count++,this.addRecord=function(name,m,fields){if(records[name])throw new Error("Record metadata already exists for: "+name);var previous=records[order[order.length-1]];if(previous&&previous.occurs.min!==previous.occurs.max)throw new Error("Records cannot be added after a repeating record");var record=new MRecordImpl(name,occurs(m));if(records[name]=record,order.push(name),void 0!==fields)for(var field in fields)record.addField(field,fields[field]);return record},this.getRecord=function(name){switch(typeof name){case"string":return records[name];case"number":return records[order[name]]}return void 0},this.getRecords=function(){return order.map(function(name){return records[name]})},this.occurs=occurs,this.name=name,this.string=function(val){return new MString(val)},this.integer=function(val){return new MInteger(val)},this.decimal=function(val,scale){return new MDecimal(val,scale)},this.getDetails=function(){return{name:name}},this.builder=function(){return new RecordContentBuilder(self)},this.parse=function(buffer){return parser.parse(buffer)}});module.exports=MRecordContentImpl},{"../../metadata/metadata":23,"./decimal":58,"./integer":59,"./string":63,"./util-single-value":65,"content/structured-record-content/builder":42,"content/structured-record-content/parser":43,"util/interface":125}],62:[function(_dereq_,module){var details={type:"stateless",name:"stateless"};module.exports=function(){this.getDetails=function(){return details},this.parse=function(buffer){return buffer}}},{}],63:[function(_dereq_,module){module.exports=function(val){var self=this;this.value=void 0===val?"":""+val,this.getDetails=function(){return{type:"string",name:"string","default":self.value}},this.parse=function(buffer){return buffer.toString()}}},{}],64:[function(_dereq_,module){module.exports={STATELESS:1,SINGLE_VALUE:3,RECORD:4}},{}],65:[function(_dereq_,module){function createFromSingleValue(value){switch(typeof value){case"string":return new MString(value);case"number":var str=""+value,i=str.indexOf(".");return i>-1?new MDecimal(value,str.length-(i+1)):new MInteger(value)}throw new Error("Invalid Single Value type",value)}function getType(metadata){if(metadata instanceof MDecimal||metadata instanceof MInteger||metadata instanceof MString)return Type.SINGLE_VALUE;if(metadata instanceof MStateless)return Type.STATELESS;throw new Error("Unknown metadata type")}function isMetadata(value){return value instanceof MStateless||value instanceof MDecimal||value instanceof MInteger||value instanceof MString}function deriveMetadata(value){return void 0===value?new MStateless:isMetadata(value)?value:createFromSingleValue(value)}var MStateless=_dereq_("./stateless"),MDecimal=_dereq_("./decimal"),MInteger=_dereq_("./integer"),MString=_dereq_("./string"),Type=_dereq_("./type");module.exports={Type:Type,getType:getType,isMetadata:isMetadata,deriveMetadata:deriveMetadata}},{"./decimal":58,"./integer":59,"./stateless":62,"./string":63,"./type":64}],66:[function(_dereq_,module){function getType(metadata){return MRecordContent.isPrototypeOf(metadata)?Type.RECORD:util.getType(metadata)}function isMetadata(value){return MRecordContent.isPrototypeOf(value)||util.isMetadata(value)}function deriveMetadata(value){return isMetadata(value)?value:util.deriveMetadata(value)}var Type=_dereq_("./type"),util=_dereq_("./util-single-value"),MRecordContent=(_dereq_("content/util"),_dereq_("./record-content"));module.exports={Type:Type,getType:getType,isMetadata:isMetadata,deriveMetadata:deriveMetadata}},{"./record-content":61,"./type":64,"./util-single-value":65,"content/util":45}],67:[function(_dereq_,module){function createConnectionRequest(){return{type:consts.TYPE,version:consts.PROTOCOL_VERSION,capabilities:consts.CAPABILITIES}}function createReconnectionRequest(token){var req=createConnectionRequest();return req.token=token,req}var consts=_dereq_("protocol/consts");module.exports={connect:createConnectionRequest,reconnect:createReconnectionRequest}},{"protocol/consts":69}],68:[function(_dereq_,module){function deserialise(buffer){var input=new BufferInputStream(buffer),protocol=input.read();if(protocol!==consts.PROTOCOL_BYTE)throw new Error("Unrecognised protocol byte: "+protocol);var version=input.read();if(version<consts.PROTOCOL_VERSION)throw new Error("Unrecognised protocol version: "+version);if(version>consts.PROTOCOL_VERSION)throw new Error("Unsupported protocol version: "+version);var responseCode=BEES.read(input,ResponseCode);if(ResponseCode.isSuccess(responseCode)){var sessionID=new SessionId(input.readUInt64(),input.readUInt64()),sessionToken=SessionTokenDeserialiser(input);return{response:responseCode,identity:sessionID,token:sessionToken,version:version,success:!0}}return{response:responseCode,version:version,identity:null,token:null,success:!1}}var BufferInputStream=_dereq_("io/buffer-input-stream"),BEES=_dereq_("api/serialisers/byte-encoded-enum-serialiser"),SessionId=_dereq_("session/session-id"),SessionTokenDeserialiser=_dereq_("session/session-token-deserialiser"),ResponseCode=_dereq_("protocol/response-code"),consts=_dereq_("protocol/consts");module.exports=deserialise},{"api/serialisers/byte-encoded-enum-serialiser":27,"io/buffer-input-stream":55,"protocol/consts":69,"protocol/response-code":70,"session/session-id":107,"session/session-token-deserialiser":108}],69:[function(_dereq_,module){module.exports={TYPE:"WB",CAPABILITIES:8,PROTOCOL_BYTE:35,PROTOCOL_VERSION:5}},{}],70:[function(_dereq_,module){function code(id,message){return{id:id,message:message}}var ResponseCode={OK:code(100,"Connected succesfully"),DOWNGRADE:code(102,"Server does not support the requested protocol level"),RECONNECTED:code(105,"Reconnected succesfully"),REJECTED:code(111,"Connection rejected"),CONNECTION_UNSUPPORTED:code(112,"Connection type not supported by connector"),LICENSE_EXCEEDED:code(113,"Connection rejected due to license limit"),RECONNECTION_UNSUPPORTED:code(114,"Reconnection not supported by connector"),CONNECTION_PROTOCOL_ERROR:code(115,"Connection failed - protocol error"),AUTHENTICATION_FAILED:code(116,"Connection failed - authentication failed"),UNKNOWN_SESSION:code(117,"Reconnection failed - the session is unknown"),ERROR:code(127,"Connection failed due to server error")};ResponseCode.isSuccess=function(code){return code===ResponseCode.OK||code===ResponseCode.RECONNECTED},module.exports=ResponseCode},{}],71:[function(_dereq_,module){module.exports={ATTR:"$",CHAR:"_"}},{}],72:[function(_dereq_,module){function createRecordSchema(metadata){if(0===metadata.getRecords().length)return null;var schema={message:{record:[]}};return schema.message[ATTR]={topicDataType:"record",name:metadata.name},metadata.getRecords().forEach(function(record){var rschema={field:[]};rschema[ATTR]=record.getDetails(),record.getFields().forEach(function(field){rschema.field.push(createSingleValueSchema(field).field)}),schema.message.record.push(rschema)}),schema}function createSingleValueSchema(metadata){var schema={field:{}};return schema.field[ATTR]=metadata.getDetails(),schema}function create(meta){switch(util.getType(meta)){case util.Type.RECORD:return createRecordSchema(meta);case util.Type.SINGLE_VALUE:return createSingleValueSchema(meta)}return null}var util=_dereq_("metadata/util"),ATTR=_dereq_("schema/consts").ATTR;module.exports=create},{"metadata/util":66,"schema/consts":71}],73:[function(_dereq_,module){var xmljson=_dereq_("./xmljson"),Codec=_dereq_("io/codec"),serialiser={read:function(input){return xmljson.xml2json(Codec.readString(input))},write:function(output,schema){Codec.writeString(output,xmljson.json2xml(schema))}};module.exports=serialiser},{"./xmljson":74,"io/codec":57}],74:[function(_dereq_,module){function attrs_str2js(str){for(var js={},pairs=str.split(" "),i=0;i<pairs.length;i++){var pair=pairs[i].split("=");js[pair[0]]=pair[1].match(/"(.*)"/)[1]}return js}function attrs_obj2arr(obj){var attrs=[];if("object"==typeof obj)for(var key in obj)attrs.push(""+key+'="'+obj[key]+'"');return attrs}function xml2json(xml,pos){var js={};if(void 0===pos){pos={idx:0,isRoot:!0};var preamble=xml.match(/<\?.*?\?>/);preamble&&(xml=xml.substr(preamble[0].length))}for(var elem_match=null;;){if(elem_match=xml.substr(pos.idx).match(/<.*?>/),!elem_match)break;pos.idx+=elem_match[0].length;var elem=elem_match[0].trim();if("</"===elem.substr(0,2))return js;var name=elem.match(/\b(.+?)\b/)[0],attrs_match=elem.match(/<.+?\b(.*)\/?>/),attrs_str="";attrs_match&&(attrs_str=attrs_match[1].trim());var child_count,attrs=attrs_str2js(attrs_str);"/>"===elem.substr(-2)?pos.isRoot?(pos.isRoot=!1,js[name]=xml2json(xml,pos),js[name][ATTR]=attrs):(js[name]||(js[name]=[]),child_count=js[name].push({}),js[name][child_count-1][ATTR]=attrs):pos.isRoot?(pos.isRoot=!1,js[name]=xml2json(xml,pos),js[name][ATTR]=attrs):(js[name]||(js[name]=[]),child_count=js[name].push(xml2json(xml,pos)),js[name][child_count-1][ATTR]=attrs)}return js}function json2xml(obj,recur){var str="";recur||(str='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>');for(var key in obj)if(key!==ATTR){var val=obj[key];val instanceof Array||(val=Array(val));for(var i=0;i<val.length;i++){var attrs=attrs_obj2arr(val[i][ATTR]);str+="<"+key,attrs&&attrs.length>0&&(str+=" ",str+=attrs.join(" "));var child_str=json2xml(val[i],!0);child_str&&child_str.length>0?(str+=">",str+=child_str,str+="</"+key+">"):str+="/>"}}return str}var ATTR=(_dereq_("../metadata/metadata"),_dereq_("../schema/schema"),_dereq_("../schema/consts").ATTR);module.exports={xml2json:xml2json,json2xml:json2xml}},{"../metadata/metadata":60,"../schema/consts":71,"../schema/schema":72}],75:[function(_dereq_,module){module.exports={EXISTS:{id:1,reason:"The topic already exists with the same details"},EXISTS_MISMATCH:{id:2,reason:"The topic already exists, with different details"},INVALID_PATH:{id:3,reason:"The topic path is invalid"},INVALID_DETAILS:{id:4,reason:"The topic details are invalid"},USER_CODE_ERROR:{id:5,reason:"A user supplied class could not be found or instantiated"},TOPIC_NOT_FOUND:{id:6,reason:"A referenced topic could not be found"},PERMISSIONS_FAILURE:{id:7,reason:"Invalid permissions to add a topic at the specified path"},INITIALISE_ERROR:{id:8,reason:"The topic could not be initialised, supplied value may be of the wrong format"},UNEXPECTED_ERROR:{id:9,reason:"An unexpected error occured while creating the topic"}}},{}],76:[function(_dereq_,module){var Codec=_dereq_("io/codec"),util=(_dereq_("io/buffer-output-stream"),_dereq_("content/util")),BEES=_dereq_("api/serialisers/byte-encoded-enum-serialiser"),AddTopicFailureReason=_dereq_("services/add-topic/add-topic-failure-reason"),TopicDetailsSerialiser=_dereq_("topics/details/topic-details-serialiser"),Status={OK:0,OK_CACHED:1,FAILURE:2,CACHE_FAILURE:3},serialiser={read:function(input){var status=Codec.readByte(input),reason="";return status===Status.FAILURE&&(reason=BEES.read(input,AddTopicFailureReason)),{status:status,reason:reason}},write:function(output,req){Codec.writeString(output,req.path),Codec.writeInt32(output,0),TopicDetailsSerialiser.write(output,req.details),req.content?(Codec.writeBoolean(output,!0),Codec.writeBytes(util.getBytes(req.content))):Codec.writeBoolean(output,!1)}};module.exports=serialiser},{"api/serialisers/byte-encoded-enum-serialiser":27,"content/util":45,"io/buffer-output-stream":56,"io/codec":57,"services/add-topic/add-topic-failure-reason":75,"topics/details/topic-details-serialiser":110}],77:[function(_dereq_,module){function AddTopic(){}module.exports=AddTopic},{}],78:[function(_dereq_,module){var codec=_dereq_("io/codec"),NO_PASSWORD=0,PLAIN_PASSWORD=1,serialiser={read:function(bis){var type=codec.readByte(bis);switch(type){case NO_PASSWORD:return null;case PLAIN_PASSWORD:return codec.readString(bis);default:return codec.readBytes(bis)}},write:function(bos,password){password?(codec.writeByte(bos,PLAIN_PASSWORD),codec.writeString(bos,password)):codec.writeByte(bos,NO_PASSWORD)}};module.exports=serialiser},{"io/codec":57}],79:[function(_dereq_,module){var Codec=_dereq_("io/codec"),ErrorReport=_dereq_("api/features/security").ErrorReport,serialiser={read:function(input){var message=Codec.readString(input),line=Codec.readInt32(input),column=Codec.readInt32(input);return new ErrorReport(message,line,column)},write:function(output,value){Codec.writeString(output,value.message),Codec.writeInt32(output,value.line),Codec.writeInt32(output,value.column)}};module.exports=serialiser},{"api/features/security":24,"io/codec":57}],80:[function(_dereq_,module){var Codec=_dereq_("io/codec"),ErrorReportSerialiser=_dereq_("./error-report-serialiser"),SecurityCommandScriptResult=_dereq_("./security-command-script-result"),serialiser={read:function(input){var errors=Codec.readCollection(input,ErrorReportSerialiser.read);return new SecurityCommandScriptResult(errors)},write:function(output,value){Codec.writeCollection(output,value.errors,ErrorReportSerialiser.write)}};module.exports=serialiser},{"./error-report-serialiser":79,"./security-command-script-result":81,"io/codec":57}],81:[function(_dereq_,module){function SecurityCommandScriptResult(errors){this.errors=requireNonNull(errors)}var requireNonNull=_dereq_("util/require-non-null");SecurityCommandScriptResult.prototype.toString=function(){return"SecurityCommandScriptResult ["+this.errors+"]"},module.exports=SecurityCommandScriptResult},{"util/require-non-null":129}],82:[function(_dereq_,module){var SecurityCommandScript=_dereq_("./security-command-script"),Codec=_dereq_("io/codec"),serialiser={read:function(input){var script=Codec.readString(input);return new SecurityCommandScript(script)},write:function(output,value){Codec.writeString(output,value.script)}};module.exports=serialiser},{"./security-command-script":83,"io/codec":57}],83:[function(_dereq_,module){function SecurityCommandScript(script){this.script=requireNonNull(script,"script")}var requireNonNull=_dereq_("util/require-non-null");SecurityCommandScript.prototype.toString=function(){return"SecurityCommandScript ["+this.script+"]"},module.exports=SecurityCommandScript},{"util/require-non-null":129}],84:[function(_dereq_,module){var Codec=_dereq_("io/codec"),Configuration=_dereq_("api/features/security").Configuration,ByteEncodedEnumSerialiser=_dereq_("api/serialisers/byte-encoded-enum-serialiser"),SystemPrincipalSerialiser=_dereq_("./system-principal-serialiser"),serialiser={read:function(input){var principals=Codec.readCollection(input,SystemPrincipalSerialiser.read),action=ByteEncodedEnumSerialiser.read(input,Configuration.CONNECTION_ACTION),roles=Codec.readCollection(input,Codec.readString);return new Configuration(principals,action.value,roles)},write:function(output,value){Codec.writeCollection(output,value.principals,SystemPrincipalSerialiser.write);var action=Configuration.CONNECTION_ACTION.fromString(value.anonymous.action);Codec.writeByte(output,action.id),Codec.writeCollection(output,value.anonymous.roles,Codec.writeString)}};module.exports=serialiser},{"./system-principal-serialiser":85,"api/features/security":24,"api/serialisers/byte-encoded-enum-serialiser":27,"io/codec":57}],85:[function(_dereq_,module){var Codec=_dereq_("io/codec"),SystemPrincipal=_dereq_("api/features/security").SystemPrincipal,serialiser={read:function(input){var name=Codec.readString(input),roles=Codec.readCollection(input,Codec.readString);return new SystemPrincipal(name,roles)},write:function(output,principal){Codec.writeString(output,principal.name),Codec.writeCollection(output,principal.roles,Codec.writeString)}};module.exports=serialiser},{"api/features/security":24,"io/codec":57}],86:[function(_dereq_,module){var Codec=_dereq_("io/codec"),ByteEncodedEnumSerialiser=_dereq_("api/serialisers/byte-encoded-enum-serialiser"),CommandError=_dereq_("./command-error"),serialiser={read:function(input){var message=Codec.readString(input),type=ByteEncodedEnumSerialiser.read(input,CommandError.ErrorType);return new CommandError(type,message)},write:function(out,error){Codec.writeString(out,error.message),ByteEncodedEnumSerialiser.write(out,error.type)}};module.exports=serialiser},{"./command-error":87,"api/serialisers/byte-encoded-enum-serialiser":27,"io/codec":57}],87:[function(_dereq_,module){function ErrorType(reason){this.reason=reason,this.id=reason.id,this.asCommandError=function(){return new CommandError(this)}}function CommandError(type,message){this.type=type,this.message=message||type.reason.reason}var ErrorReasons=_dereq_("client/errors");CommandError.prototype.toString=function(){return this.message},CommandError.ErrorType={COMMUNICATION_FAILURE:new ErrorType(ErrorReasons.COMMUNICATION_FAILURE),ACCESS_DENIED:new ErrorType(ErrorReasons.ACCESS_DENIED),TOPIC_TREE_REGISTATION_CONFLICT:new ErrorType(ErrorReasons.TOPIC_TREE_REGISTRATION_CONFLICT)},module.exports=CommandError},{"client/errors":31}],88:[function(_dereq_,module){var ConversationIDSerialiser=_dereq_("conversation/conversation-id-serialiser"),CommandHeader=_dereq_("./command-header"),Codec=_dereq_("io/codec"),CommandHeaderSerialiser={read:function(input){var service=Codec.readInt32(input),mode=Codec.readByte(input),cid=ConversationIDSerialiser.read(input);return new CommandHeader(mode,service,cid)},write:function(out,header){Codec.writeInt32(out,header.service),Codec.writeByte(out,header.mode),ConversationIDSerialiser.write(out,header.cid)}};module.exports=CommandHeaderSerialiser},{"./command-header":89,"conversation/conversation-id-serialiser":46,"io/codec":57}],89:[function(_dereq_,module){function CommandHeader(mode,service,cid){this.mode=mode,this.service=service,this.cid=cid}var modes={ERROR:0,REQUEST:1,RESPONSE:2};CommandHeader.prototype.toString=function(){var mode;switch(this.mode){case modes.ERROR:mode="Error";break;case modes.REQUEST:mode="Request";break;case modes.RESPONSE:mode="Response"}return mode+"<"+this.service+", "+this.cid.toString()+">"},CommandHeader.createRequestHeader=function(service,cid){return new CommandHeader(modes.REQUEST,service,cid)},CommandHeader.prototype.createResponseHeader=function(){return new CommandHeader(modes.RESPONSE,this.service,this.cid)},CommandHeader.prototype.createErrorHeader=function(){return new CommandHeader(modes.ERROR,this.service,this.cid)},CommandHeader.modes=modes,CommandHeader.prototype.mode=modes,module.exports=CommandHeader},{}],90:[function(_dereq_,module){var Codec=_dereq_("io/codec"),TopicDetailsSerialiser=(_dereq_("./get-topic-details"),_dereq_("topics/details/topic-details-serialiser")),serialiser={read:function(input){return TopicDetailsSerialiser.read(input)},write:function(output,request){Codec.writeString(output,request.topic_name),Codec.writeByte(output,request.level)}};module.exports=serialiser},{"./get-topic-details":91,"io/codec":57,"topics/details/topic-details-serialiser":110}],91:[function(_dereq_,module){function GetTopicDetails(){}module.exports=GetTopicDetails},{}],92:[function(_dereq_,module){var Codec=(_dereq_("./remove-topic"),_dereq_("io/codec")),serialiser={read:function(){},write:function(output,req){Codec.writeString(output,req.topic_name)}};module.exports=serialiser},{"./remove-topic":93,"io/codec":57}],93:[function(_dereq_,module){function RemoveTopic(){}module.exports=RemoveTopic},{}],94:[function(_dereq_,module){var HashMap=_dereq_("hashmap").HashMap,CommandHeader=_dereq_("services/command-header"),CommandHeaderSerialiser=_dereq_("services/command-header-serialiser"),CommandError=_dereq_("services/command-error"),CommandErrorSerialiser=_dereq_("services/command-error-serialiser"),TopicSelector=_dereq_("../../topics/topic-selector"),TopicSelectorSerialiser=_dereq_("topics/topic-selector-serialiser"),serialisers=new HashMap;serialisers.set(CommandError,CommandErrorSerialiser),serialisers.set(CommandHeader,CommandHeaderSerialiser),serialisers.set(TopicSelector,TopicSelectorSerialiser),serialisers.set(null,{read:function(){return null},write:function(){}}),serialisers.set(_dereq_("./subscription-notification/subscription-notification"),_dereq_("./subscription-notification/subscription-notification-serialiser")),serialisers.set(_dereq_("./unsubscription-notification/unsubscription-notification"),_dereq_("./unsubscription-notification/unsubscription-notification-serialiser")),serialisers.set(_dereq_("./get-topic-details/get-topic-details"),_dereq_("./get-topic-details/get-topic-details-serialiser")),serialisers.set(_dereq_("./add-topic/add-topic"),_dereq_("./add-topic/add-topic-serialiser")),serialisers.set(_dereq_("./remove-topic/remove-topic"),_dereq_("./remove-topic/remove-topic-serialiser")),serialisers.set(_dereq_("./topic-update/topic-update"),_dereq_("./topic-update/topic-update-serialiser")),serialisers.set(_dereq_("./wills/topic-will-parameters"),_dereq_("./wills/topic-will-parameters-serialiser")),serialisers.set(_dereq_("./wills/will-registration-result"),_dereq_("./wills/will-registration-result-serialiser"));var security=_dereq_("../../features/security");serialisers.set(security.ErrorReport,_dereq_("./authentication/error-report-serialiser")),serialisers.set(security.Configuration,_dereq_("./authentication/system-authentication-configuration-serialiser")),serialisers.set(security.SystemPrincipal,_dereq_("./authentication/system-principal-serialiser")),serialisers.set(_dereq_("./authentication/security-command-script"),_dereq_("./authentication/security-command-script-serialiser")),serialisers.set(_dereq_("./authentication/security-command-script-result"),_dereq_("./authentication/security-command-script-result-serialiser")),serialisers.set(_dereq_("session/session-id"),_dereq_("session/session-id-serialiser")),module.exports=serialisers},{"../../features/security":20,"../../topics/topic-selector":139,"./add-topic/add-topic":77,"./add-topic/add-topic-serialiser":76,"./authentication/error-report-serialiser":79,"./authentication/security-command-script":83,"./authentication/security-command-script-result":81,"./authentication/security-command-script-result-serialiser":80,"./authentication/security-command-script-serialiser":82,"./authentication/system-authentication-configuration-serialiser":84,"./authentication/system-principal-serialiser":85,"./get-topic-details/get-topic-details":91,"./get-topic-details/get-topic-details-serialiser":90,"./remove-topic/remove-topic":93,"./remove-topic/remove-topic-serialiser":92,"./subscription-notification/subscription-notification":97,"./subscription-notification/subscription-notification-serialiser":96,"./topic-update/topic-update":99,"./topic-update/topic-update-serialiser":98,"./unsubscription-notification/unsubscription-notification":101,"./unsubscription-notification/unsubscription-notification-serialiser":100,"./wills/topic-will-parameters":103,"./wills/topic-will-parameters-serialiser":102,"./wills/will-registration-result":105,"./wills/will-registration-result-serialiser":104,hashmap:9,"services/command-error":87,"services/command-error-serialiser":86,"services/command-header":89,"services/command-header-serialiser":88,"session/session-id":107,"session/session-id-serialiser":106,"topics/topic-selector-serialiser":119}],95:[function(_dereq_,module){var TopicSelector=_dereq_("../../topics/topic-selector"),SubscriptionNotification=_dereq_("services/subscription-notification/subscription-notification"),UnsubscriptionNotification=_dereq_("services/unsubscription-notification/unsubscription-notification"),GetTopicDetails=_dereq_("services/get-topic-details/get-topic-details"),AddTopic=_dereq_("services/add-topic/add-topic"),RemoveTopic=_dereq_("services/remove-topic/remove-topic"),TopicUpdate=_dereq_("services/topic-update/topic-update"),SecurityCommandScript=_dereq_("services/authentication/security-command-script"),SecurityCommandScriptResult=_dereq_("services/authentication/security-command-script-result"),SystemAuthenticationConfiguration=_dereq_("../../features/security").Configuration,TopicWillParameters=_dereq_("services/wills/topic-will-parameters"),WillRegistrationResult=_dereq_("services/wills/will-registration-result");module.exports={SUBSCRIBE:{id:3,name:"Subscribe",request:TopicSelector,response:null},UNSUBSCRIBE:{id:4,name:"Unsubscribe",request:TopicSelector,response:null},TOPIC_UPDATE:{id:36,name:"Topic Update",request:TopicUpdate,response:TopicUpdate},SUBSCRIPTION_NOTIFICATION:{id:40,name:"Subscription Notification",request:SubscriptionNotification,response:null},GET_TOPIC_DETAILS:{id:41,name:"Get Topic Details",request:GetTopicDetails,response:GetTopicDetails},UNSUBSCRIPTION_NOTIFICATION:{id:42,name:"Unsubscription Notification",request:UnsubscriptionNotification,response:null},ADD_TOPIC:{id:46,name:"Add Topic",request:AddTopic,response:AddTopic},REMOVE_TOPIC:{id:47,name:"Remove Topic",request:RemoveTopic,response:RemoveTopic},TOPIC_SCOPED_WILL_REGISTRATION:{id:53,name:"Topic Will Registration",request:TopicWillParameters,response:WillRegistrationResult},TOPIC_SCOPED_WILL_DEREGISTRATION:{id:54,name:"Topic Will Deregistration",request:TopicWillParameters,response:null},SYSTEM_PING:{id:55,name:"System Ping",request:null,response:null},USER_PING:{id:56,name:"User Ping",request:null,response:null},GET_SYSTEM_AUTHENTICATION:{id:57,name:"Get System Authentication",request:null,response:SystemAuthenticationConfiguration},UPDATE_SYSTEM_AUTHENTICATION:{id:58,name:"Update System Authentication",request:SecurityCommandScript,response:SecurityCommandScriptResult}}},{"../../features/security":20,"../../topics/topic-selector":139,"services/add-topic/add-topic":77,"services/authentication/security-command-script":83,"services/authentication/security-command-script-result":81,"services/get-topic-details/get-topic-details":91,"services/remove-topic/remove-topic":93,"services/subscription-notification/subscription-notification":97,"services/topic-update/topic-update":99,"services/unsubscription-notification/unsubscription-notification":101,"services/wills/topic-will-parameters":103,"services/wills/will-registration-result":105}],96:[function(_dereq_,module){var TopicInfoSerialiser=_dereq_("topics/details/topic-info-serialiser"),SubscriptionNotification=_dereq_("./subscription-notification");module.exports={read:function(input){var info=TopicInfoSerialiser.read(input);return new SubscriptionNotification(info)},write:function(out,notification){TopicInfoSerialiser.write(out,notification.info)}}},{"./subscription-notification":97,"topics/details/topic-info-serialiser":112}],97:[function(_dereq_,module){function SubscriptionNotification(info){this.info=info}module.exports=SubscriptionNotification},{}],98:[function(_dereq_,module){var Codec=_dereq_("io/codec"),ContentSerialiser=_dereq_("../../content/serialiser"),ResultCodes=(_dereq_("../../conversation/conversation-id-serialiser"),{SUCCESS:0,INCOMPATIBLE_UPDATE:1,UPDATE_FAILED:2,INVALID_UPDATER:3,MISSING_TOPIC:4,INVALID_ADDRESS:5,DUPLICATES:6}),getReason=function(code){for(var key in ResultCodes)if(ResultCodes[key]===code)return key;return"UNKNOWN"},isError=function(code){return code===ResultCodes.SUCCESS?!1:!0};module.exports={read:function(input){var status=Codec.readByte(input);return{status:status,reason:getReason(status),isError:isError(status)}},write:function(output,request){Codec.writeString(output,request.topic_path),ContentSerialiser.write(output,request.content)}}},{"../../content/serialiser":41,"../../conversation/conversation-id-serialiser":46,"io/codec":57}],99:[function(_dereq_,module){function TopicUpdate(){}module.exports=TopicUpdate
},{}],100:[function(_dereq_,module){var UnsubscribeReason=_dereq_("../../../features/topics").UnsubscribeReason,TopicIdSerialiser=_dereq_("topics/details/topic-id-serialiser"),UnsubscriptionNotification=_dereq_("./unsubscription-notification"),ByteEncodedEnumSerialiser=_dereq_("api/serialisers/byte-encoded-enum-serialiser");module.exports={read:function(input){var id=TopicIdSerialiser.read(input),reason=ByteEncodedEnumSerialiser.read(input,UnsubscribeReason);return new UnsubscriptionNotification(id,reason)},write:function(out,notification){TopicIdSerialiser.write(out,notification.id),ByteEncodedEnumSerialiser.write(out,notification.reason)}}},{"../../../features/topics":22,"./unsubscription-notification":101,"api/serialisers/byte-encoded-enum-serialiser":27,"topics/details/topic-id-serialiser":111}],101:[function(_dereq_,module){function UnsubscriptionNotification(id,reason){this.id=id,this.reason=reason}module.exports=UnsubscriptionNotification},{}],102:[function(_dereq_,module){var BEES=_dereq_("api/serialisers/byte-encoded-enum-serialiser"),TopicWillParameters=_dereq_("./topic-will-parameters"),Codec=_dereq_("io/codec"),serialiser={read:function(input){var path=Codec.readString(input),will=BEES.read(input,TopicWillParameters.Will);return new TopicWillParameters(path,will)},write:function(out,params){Codec.writeString(out,params.path),BEES.write(out,params.will)}};module.exports=serialiser},{"./topic-will-parameters":103,"api/serialisers/byte-encoded-enum-serialiser":27,"io/codec":57}],103:[function(_dereq_,module){function TopicWillParameters(path,will){this.path=path,this.will=will}var Will={REMOVE_TOPICS:0};TopicWillParameters.prototype.toString=function(){return"TopicWillParams ["+this.will+", "+this.path+"]"},TopicWillParameters.Will=Will,module.exports=TopicWillParameters},{}],104:[function(_dereq_,module){var BEES=_dereq_("api/serialisers/byte-encoded-enum-serialiser"),WillRegistrationResult=_dereq_("./will-registration-result"),serialiser={read:function(input){return BEES.read(input,WillRegistrationResult)},write:function(output,result){BEES.write(output,result)}};module.exports=serialiser},{"./will-registration-result":105,"api/serialisers/byte-encoded-enum-serialiser":27}],105:[function(_dereq_,module){var WillRegistrationResult={SUCCESS:0,GROUP_CONFLICT:1,TOPIC_TREE_CONFLICT:2};WillRegistrationResult.toString=function(){return"WillRegistrationResult"},module.exports=WillRegistrationResult},{}],106:[function(_dereq_,module){var SessionID=_dereq_("session/session-id"),Codec=_dereq_("io/codec"),serialiser={read:function(input){var server=Codec.readInt64(input),value=Codec.readInt64(input);return new SessionID(server,value)},write:function(output,sessionID){Codec.writeInt64(output,sessionID.server),output.writeInt64(output,sessionID.value)}};module.exports=serialiser},{"io/codec":57,"session/session-id":107}],107:[function(_dereq_,module){function SessionId(server,value){this.server=server,this.value=value}SessionId.prototype.toString=function(){var val="0000000000000000"+this.value.toString(16);return(this.server.toString(16)+"-"+val.substr(val.length-16)).toUpperCase()},SessionId.prototype.toValue=function(){return this.toString()},module.exports=SessionId},{}],108:[function(_dereq_,module){function readToken(input){return new SessionToken(input.readMany(SessionToken.TOKEN_LENGTH))}var SessionToken=_dereq_("session/session-token");module.exports=readToken},{"session/session-token":109}],109:[function(_dereq_,module){(function(Buffer){function SessionToken(external){this.put=function(destination){destination.writeBytes(external)},this.toString=function(){return external.toString("ascii")}}var TOKEN_LENGTH=24;SessionToken.fromExternalString=function(external){return new SessionToken(new Buffer(external,"ascii"))},SessionToken.TOKEN_LENGTH=TOKEN_LENGTH,module.exports=SessionToken}).call(this,_dereq_("buffer").Buffer)},{buffer:2}],110:[function(_dereq_,module){var Codec=_dereq_("io/codec"),util=_dereq_("metadata/util"),createSchema=_dereq_("schema/schema"),serialiser=_dereq_("schema/serialiser");module.exports={read:function(input){if(Codec.readBoolean(input)){{Codec.readInt32(input)}if(Codec.readBoolean(input))return serialiser.read(input)}return null},write:function(output,meta){if(meta){Codec.writeBoolean(output,!0);var type=util.getType(meta);Codec.writeInt32(output,type);var schema=createSchema(meta);schema?(Codec.writeBoolean(output,!0),serialiser.write(output,schema)):Codec.writeBoolean(output,!1),Codec.writeBoolean(output,!1)}else Codec.writeBoolean(output,!1)}}},{"io/codec":57,"metadata/util":66,"schema/schema":72,"schema/serialiser":73}],111:[function(_dereq_,module){var Codec=_dereq_("io/codec"),serialiser={read:function(bis){return Codec.readInt32(bis)},write:function(bos,id){Codec.writeInt32(bos,id)}};module.exports=serialiser},{"io/codec":57}],112:[function(_dereq_,module){var Codec=_dereq_("io/codec"),TopicIdSerialiser=_dereq_("./topic-id-serialiser"),TopicDetailsSerialiser=_dereq_("./topic-details-serialiser"),serialiser={read:function(input){return{id:TopicIdSerialiser.read(input),path:Codec.readString(input),details:TopicDetailsSerialiser.read(input)}},write:function(out,info){TopicIdSerialiser.write(out,info.id),Codec.writeString(out,info.path),TopicDetailsSerialiser.write(out,info.details)}};module.exports=serialiser},{"./topic-details-serialiser":110,"./topic-id-serialiser":111,"io/codec":57}],113:[function(_dereq_,module){function FullPathSelector(components){switch(components.qualifier){case DQ.MATCH:this.regex=regex(components.base);break;case DQ.DESCENDANTS_OF_MATCH:this.regex=regex(components.base+"/.+");break;case DQ.MATCH_AND_DESCENDANTS:this.regex=regex(components.base+"(?:$|/.+)")}TopicSelector.call(this,components.type,components.prefix,components.expression)}var inherits=_dereq_("inherits"),regex=_dereq_("util/regex"),utils=_dereq_("topics/topic-path-utils"),TopicSelector=_dereq_("../../topics/topic-selector"),DQ=utils.DescendantQualifier;inherits(FullPathSelector,TopicSelector),FullPathSelector.prototype._doSelects=function(topicPath){return this.regex(topicPath)},module.exports=FullPathSelector},{"../../topics/topic-selector":139,inherits:10,"topics/topic-path-utils":117,"util/regex":128}],114:[function(_dereq_,module){function TopicPathSelector(components){var remainder=components.remainder;if(components.type===TopicSelector.Type.PATH){if(components.qualifier.includesDescendants)throw new Error("Topic path cannot select descendants: "+remainder);if(""===components.prefix)throw new Error("Topic path must have at least one part: "+remainder);if(components.prefix.indexOf("//")>-1)throw new Error("Topic path contains empty part: "+remainder)}this.qualifier=components.qualifier,this.path=components.prefix,TopicSelector.call(this,components.type,components.prefix,components.expression)}var inherits=_dereq_("inherits"),utils=_dereq_("topics/topic-path-utils"),TopicSelector=_dereq_("../../topics/topic-selector"),DQ=utils.DescendantQualifier;inherits(TopicPathSelector,TopicSelector),TopicPathSelector.prototype._doSelects=function(topicPath){var match=this.path===topicPath,descendants=0===topicPath.indexOf(this.path+"/");switch(this.qualifier){case DQ.MATCH:return match;case DQ.DESCENDANTS_OF_MATCH:return descendants;case DQ.MATCH_AND_DESCENDANTS:return match||descendants;default:return!1}},module.exports=TopicPathSelector},{"../../topics/topic-selector":139,inherits:10,"topics/topic-path-utils":117}],115:[function(_dereq_,module){function extractCommonPrefix(selectors){if(0===selectors.length)return"";var minimum=2147483647,prefixes=[],i=0;selectors.forEach(function(selector){var part=utils.split(selector.prefix);minimum=Math.min(minimum,part.length),prefixes[i++]=part});var composite=[];assembly:for(var j=0;minimum>j;++j){for(var part=prefixes[0][j],k=0;k<prefixes.length;++k)if(part!==prefixes[k][j])break assembly;composite.push(part),composite.push(utils.PATH_SEPARATOR)}return utils.canonicalise(composite.join(""))}function SelectorSet(selectors){var expanded=[];selectors.forEach(function(selector){selector instanceof SelectorSet?selector.selectors.forEach(function(nested){expanded.push(nested)}):expanded.push(selector)}),this.selectors=expanded;var remainder=expanded.join(DELIMITER),prefix=extractCommonPrefix(expanded);TopicSelector.call(this,TopicSelector.Type.SELECTOR_SET,prefix,TopicSelector.Prefix.SELECTOR_SET+remainder)}var inherits=_dereq_("inherits"),utils=_dereq_("topics/topic-path-utils"),TopicSelector=_dereq_("../../topics/topic-selector"),DELIMITER="////";SelectorSet.DELIMITER=DELIMITER,inherits(SelectorSet,TopicSelector),SelectorSet.prototype.selects=function(topicPath){for(var i=0;i<this.selectors.length;++i)if(this.selectors[i].selects(topicPath))return!0;return!1},module.exports=SelectorSet},{"../../topics/topic-selector":139,inherits:10,"topics/topic-path-utils":117}],116:[function(_dereq_,module){function SplitPathSelector(components){this.qualifier=components.qualifier,this.patterns=[];var parts=utils.split(components.base);parts.forEach(function(p){this.patterns.push(regex(p))}.bind(this)),TopicSelector.call(this,components.type,components.prefix,components.expression)}var inherits=_dereq_("inherits"),regex=_dereq_("util/regex"),utils=_dereq_("topics/topic-path-utils"),TopicSelector=_dereq_("../../topics/topic-selector"),DQ=utils.DescendantQualifier;inherits(SplitPathSelector,TopicSelector),SplitPathSelector.prototype._doSelects=function(topicPath){var length=this.patterns.length,parts=topicPath.split(utils.PATH_SEPARATOR);switch(this.qualifier){case DQ.MATCH:if(parts.length!==length)return!1;break;case DQ.DESCENDANTS_OF_MATCH:if(parts.length<=length)return!1;break;case DQ.MATCH_AND_DESCENDANTS:if(parts.length<length)return!1}for(var i=0;length>i;++i)if(!this.patterns[i](parts[i]))return!1;return!0},module.exports=SplitPathSelector},{"../../topics/topic-selector":139,inherits:10,"topics/topic-path-utils":117,"util/regex":128}],117:[function(_dereq_,module){function split(path){return path.split(PATH_SEPARATOR)}function canonicalise(path){if(!path)return"";var l=path.length,s=l>0&&path.charAt(0)===PATH_SEPARATOR?1:0,e=l>1&&path.charAt(l-1)===PATH_SEPARATOR?1:0;return path.substring(s,l-e)}function DQ(descendants){this.includesDescendants=descendants}var PATH_SEPARATOR="/",qualifiers={MATCH:new DQ(!1),DESCENDANTS_OF_MATCH:new DQ(!0),MATCH_AND_DESCENDANTS:new DQ(!0)};module.exports={split:split,canonicalise:canonicalise,PATH_SEPARATOR:PATH_SEPARATOR,DescendantQualifier:qualifiers}},{}],118:[function(_dereq_,module){function parse(expression){if(!expression)throw new Error("Empty topic selector expression");if(expression instanceof Array)return expression.forEach(function(s){if(!(s instanceof TopicSelector))throw new Error("Can only parse arrays of Topic Selectors")}),new SelectorSet(expression);if("string"==typeof expression){var components=getComponents(expression);if(isTopicPath(components))return new PathSelector(components);switch(components.type){case T.SPLIT_PATH_PATTERN:return new SplitPathSelector(components);case T.FULL_PATH_PATTERN:return new FullPathSelector(components);case T.SELECTOR_SET:var parts=split(components.remainder,SelectorSet.DELIMITER),selectors=[];return parts.forEach(function(e){selectors.push(parse(e))}),new SelectorSet(selectors)}}throw new Error("Topic selector expression must be a string or array")}function getComponents(expression){var type=getType(expression);if(null===type){if(!isAlphaNumeric(expression[0]))throw new Error("Invalid expression type: "+expression);expression=P.PATH+expression,type=T.PATH}var qualifier,prefix,base,remainder=expression.substring(1);return type===T.PATH?(base=remainder,qualifier=DQ.MATCH):"/"===remainder[remainder.length-1]?"/"===remainder[remainder.length-2]?(qualifier=DQ.MATCH_AND_DESCENDANTS,base=remainder.substring(0,remainder.length-2)):(qualifier=DQ.DESCENDANTS_OF_MATCH,base=remainder.substring(0,remainder.length-1)):(base=remainder,qualifier=DQ.MATCH),prefix=type===T.PATH?utils.canonicalise(remainder):extractPrefixFromRegex(base),{type:type,base:base,prefix:prefix,remainder:remainder,qualifier:qualifier,expression:type+remainder}}function isTopicPath(c){return c.type===T.PATH?!0:c.type===T.SELECTOR_SET||""===c.prefix?!1:c.prefix===c.base}function isAlphaNumeric(c){return!isNaN(parseInt(c,10))||c>="a"&&"z">=c||c>="A"&&"Z">=c}function getType(expression){switch(expression[0]){case P.PATH:return T.PATH;case P.SPLIT_PATH_PATTERN:return T.SPLIT_PATH_PATTERN;case P.FULL_PATH_PATTERN:return T.FULL_PATH_PATTERN;case P.SELECTOR_SET:return T.SELECTOR_SET;default:return null}}function extractPrefixFromRegex(remainder){for(var buffer=[],composite=[],validator=normal,i=0,l=remainder.length;l>i;++i){var char=remainder[i];if("\\"===char&&l-1>i){var next=remainder[i+1];if(validator===normal&&"Q"===next)validator=quoted;else if(validator===quoted&&"E"===next)validator=normal;else{if(!("a">next||next>"z")||!("A">next||next>"Z")){buffer.length=0;break}buffer.push(next)}i++}else{if(!validator(char)){buffer.length=0;break}char===utils.PATH_SEPARATOR&&(composite.push(buffer.join("")),buffer.length=0),buffer.push(char)}}return composite.push(buffer.join("")),utils.canonicalise(composite.join(""))}var split=_dereq_("util/string").split,cache=_dereq_("util/memoize"),TopicSelector=_dereq_("../../topics/topic-selector"),utils=_dereq_("topics/topic-path-utils"),PathSelector=_dereq_("topics/path-selector"),SplitPathSelector=_dereq_("topics/split-path-selector"),FullPathSelector=_dereq_("topics/full-path-selector"),SelectorSet=_dereq_("topics/selector-set"),T=TopicSelector.Type,P=TopicSelector.Prefix,DQ=utils.DescendantQualifier,metaChars=["*",".","+","?","^","$","{","}","(",")","[","]","\\"],normal=function(c){return-1===metaChars.indexOf(c)},quoted=function(){return!0};module.exports=cache(parse)},{"../../topics/topic-selector":139,"topics/full-path-selector":113,"topics/path-selector":114,"topics/selector-set":115,"topics/split-path-selector":116,"topics/topic-path-utils":117,"util/memoize":127,"util/string":130}],119:[function(_dereq_,module){var Codec=_dereq_("io/codec"),parser=_dereq_("./topic-selector-parser"),topicSelectorSerialiser={read:function(input){return parser(Codec.readString(input))},write:function(out,selector){Codec.writeString(out,selector.expression)}};module.exports=topicSelectorSerialiser},{"./topic-selector-parser":118,"io/codec":57}],120:[function(_dereq_,module){function Transports(){this.get=function(opts){return new WSTransport(opts)}}var WSTransport=_dereq_("transports/ws");Transports.create=function(){return new Transports},module.exports=Transports},{"transports/ws":121}],121:[function(_dereq_,module){(function(Buffer){function constructURI(req,opts){var scheme=opts.ssl?"wss":"ws",uri=scheme+"://"+opts.host+":"+opts.port+"/diffusion";return uri+="?ty="+req.type,uri+="&v="+req.version,uri+="&ca="+req.capabilities,req.token&&(uri+="&c="+req.token),opts.credentials&&(uri+="&username="+encodeURIComponent(opts.credentials.principal),uri+="&password="+encodeURIComponent(encodeAsString(opts.credentials.password))),uri}function WSTransport(opts,ws){if(constructor=ws||constructor,!constructor||!constructor instanceof Function)throw log.warn("No WebSocket available"),new Error("No available WebSocket constructor");var socket,emitter=Emitter.assign(this),handler=function(message){emitter.emit("data",new Buffer(new Uint8Array(message.data)))};this.connect=function(req,handshake){try{var uri=constructURI(req,opts);socket=new constructor(uri),log.debug("Created websocket",uri)}catch(error){throw new Error("Unable to construct WebSocket",error)}socket.binaryType="arraybuffer",socket.onmessage=function(msg){socket.onmessage=handler,handshake(new Buffer(new Uint8Array(msg.data)))},socket.onclose=emitter.close,socket.onerror=emitter.error},this.dispatch=function(message){return log.trace("Sending websocket message"),socket.send(message),!0},this.close=function(){log.debug("Closing websocket"),socket.close()}}{var constructor,encodeAsString=_dereq_("v4-stack/credential-tunnel").encodeAsString,NodeWebSocket=_dereq_("ws"),Emitter=_dereq_("events/emitter"),log=_dereq_("util/logger").create("Websocket transport");_dereq_("util/logger").curry}"function"==typeof NodeWebSocket?(log.debug("Using Node WS library"),constructor=NodeWebSocket):(log.debug("Using native websocket"),constructor=WebSocket),module.exports=WSTransport}).call(this,_dereq_("buffer").Buffer)},{buffer:2,"events/emitter":50,"util/logger":126,"v4-stack/credential-tunnel":135,ws:1}],122:[function(_dereq_,module){function remove(arr,e){var i=arr.indexOf(e);return i>-1?(arr.splice(i,1),!0):!1}function argumentsToArray(args){return s.call(args,0)}var s=Array.prototype.slice;module.exports={remove:remove,argumentsToArray:argumentsToArray}},{}],123:[function(_dereq_,module){function FSM(initial,states){var emitter=Emitter.assign(this),current=states[initial];this.state=initial,this.change=function(state){return this.state===state?!0:states[state]&&("*"===current||current.indexOf(state)>-1)?(emitter.emit("change",this.state,state),current=states[state],this.state=state,!0):!1}}var Emitter=_dereq_("events/emitter");module.exports={create:function(initial,states){return new FSM(initial,states)}}},{"events/emitter":50}],124:[function(_dereq_,module){function curry(){var args=a2a(arguments),fn=args.shift();return function(){return callWithArguments(fn,args.concat(a2a(arguments)))}}function callWithArguments(f,args,count){switch(count=void 0===count?args.length:count){case 0:return f();case 1:return f(args[0]);case 2:return f(args[0],args[1]);case 3:return f(args[0],args[1],args[2]);case 4:return f(args[0],args[1],args[2],args[3]);case 5:return f(args[0],args[1],args[2],args[3],args[4]);case 6:return f(args[0],args[1],args[2],args[3],args[4],args[5]);case 7:return f(args[0],args[1],args[2],args[3],args[4],args[5],args[6]);case 8:return f(args[0],args[1],args[2],args[3],args[4],args[5],args[6],args[7])}return f.apply(f,args)}function newWithArguments(f,args,count){function Proxy(){f.apply(this,args)}switch(count=void 0===count?args.length:count){case 0:return new f;case 1:return new f(args[0]);case 2:return new f(args[0],args[1]);case 3:return new f(args[0],args[1],args[2]);case 4:return new f(args[0],args[1],args[2],args[3]);case 5:return new f(args[0],args[1],args[2],args[3],args[4]);case 6:return new f(args[0],args[1],args[2],args[3],args[4],args[5]);case 7:return new f(args[0],args[1],args[2],args[3],args[4],args[5],args[6]);case 8:return new f(args[0],args[1],args[2],args[3],args[4],args[5],args[6],args[7])}return Proxy.prototype=f.prototype,new Proxy}var a2a=_dereq_("util/array").argumentsToArray;module.exports={curry:curry,callWithArguments:callWithArguments,newWithArguments:newWithArguments}},{"util/array":122}],125:[function(_dereq_,module){function interface(){var args=array.argumentsToArray(arguments),name=args.shift(),members=args.pop()||[];args.forEach(function(ex){members=members.concat(ex.members)});var boundMembers=members.map(function(member){return{name:member,check:function(impl){return void 0===impl[member]},"throw":function(){throw new Error(name+"#"+member+'" must be implemented')}}}),filter=function(implementation){return boundMembers.filter(function(member){return member.check(implementation)})};return filter.toString=function(){return name},filter.members=members,filter}function implements(){var constructor,args=Array.prototype.slice.call(arguments,0),impl=args.pop(),unsatisfied=[];if(impl instanceof Function)constructor=impl,impl=constructor.prototype;else{constructor=impl.__constructor||function(){};for(var m in constructor.prototype)impl[m]=constructor.prototype[m]}if(args.forEach(function(interface){unsatisfied=unsatisfied.concat(interface(impl))}),constructor.prototype=impl,0===unsatisfied.length)return constructor;var proxy=function(){var instance=functions.newWithArguments(constructor,arguments);return unsatisfied.forEach(function(m){m.check(instance)&&m["throw"]()}),instance};return proxy.toString=function(){return constructor.toString()},proxy.isPrototypeOf=function(c){return c instanceof constructor},proxy.__constructor=constructor,proxy}var functions=_dereq_("util/function"),array=_dereq_("util/array");module.exports={"interface":interface,"implements":implements}},{"util/array":122,"util/function":124}],126:[function(_dereq_,module){function d(){return new Date}function log(level,prefix){var c="|"+level.toUpperCase()+"|"+prefix+"|";return function(msg,arg){arg?logger[level](d()+c+msg,arg):logger[level](d()+c+msg)}}function create(classname){var l={};return methods.forEach(function(m){l[m]=log(m,classname)}),l}var logger=_dereq_("loglevel"),methods=["trace","debug","info","warn","error"];module.exports={create:create,setLevel:logger.setLevel}},{loglevel:11}],127:[function(_dereq_,module){function defaultCacheKey(args){return args}function memoize(f,cache,matcher){matcher=matcher||defaultCacheKey,cache=cache||{};var c=function(){var args=a2a(arguments),a=matcher(args),r=cache[a];return r?r:(r=f.apply(f,args),cache[a]=r,r)};return c._uncached=f,c}var a2a=_dereq_("./array").argumentsToArray;module.exports=memoize},{"./array":122}],128:[function(_dereq_,module){function regex(s,context){if(context=context||"",""===s)throw new Error("Empty regular expression ["+context+"]");try{var r=new RegExp(s);return function(test){var m=r.exec(test);return m&&m[0]===test}}catch(e){throw new Error("Bad regular expression ["+e.message+", "+context+"]")}}module.exports=regex},{}],129:[function(_dereq_,module){function requireNonNull(value,what){if("undefined"==typeof value||null===value)throw new Error(what+" is null");return value}module.exports=requireNonNull},{}],130:[function(_dereq_,module){function split(str,delim){if(""===str)return[];for(var parts=[],l=delim.length,i=str.lastIndexOf(delim);i>-1;)parts.push(str.substring(i+l,str.length)),str=str.substring(0,i),i=str.lastIndexOf(delim);return parts.push(str),parts.reverse()}module.exports={split:split}},{}],131:[function(_dereq_,module){function AliasMap(){var aliases={};this.establish=function(topic){var bang=topic.indexOf("!");if(-1!==bang){if(0===bang)return aliases[topic.substring(1)];var alias=topic.substring(bang+1);return topic=topic.substring(0,bang),aliases[alias]=topic,topic}return topic}}AliasMap.create=function(){return new AliasMap},module.exports=AliasMap},{}],132:[function(_dereq_,module){function reason(id,message,canReconnect){return{id:id,message:message,canReconnect:canReconnect}}var CloseReason={CLOSED_BY_CLIENT:reason(0,"The session was closed by the client",!1),CLOSED_BY_SERVER:reason(1,"The session was closed by the server",!1),RECONNECT_ABORTED:reason(2,"Client aborted a reconnect attempt",!1),CONNECTION_TIMEOUT:reason(3,"The connection attempt timed out",!1),HANDSHAKE_REJECTED:reason(4,"The connection handshake was rejected by the server",!1),HANDSHAKE_ERROR:reason(5,"There was an error parsing the handshake response",!1),TRANSPORT_ERROR:reason(6,"There was an unexpected error with the connection",!0),CONNECTION_ERROR:reason(7,"A connection to the server was unable to be established",!0)};module.exports=CloseReason},{}],133:[function(_dereq_,module){var Connection=_dereq_("v4-stack/connection");module.exports.create=function(aliases,transports){return new Connection(aliases,transports)}},{"v4-stack/connection":134}],134:[function(_dereq_,module){(function(global){function Connection(aliases,transports){function onData(data){logger.trace("Received message from transport",data);try{var message=Message.parse(data);message.topic&&(message.topic=aliases.establish(message.topic)),emitter.emit("data",message)}catch(e){logger.warn("Unable to parse message",e),fsm.change("closed")&&(closeReason=CloseReason.CONNECTION_ERROR,transport.close())}}function onClose(reason){fsm.change("disconnected")||fsm.change("closed")?(clearTimeout(scheduledClose),logger.trace("Transport closed: ",reason),"disconnected"===fsm.state?emitter.emit("disconnect",closeReason):emitter.close(closeReason)):logger.debug("Unable to disconnect, current state: ",fsm.state)}function handshake(message){clearTimeout(scheduledClose),logger.debug("Received connection handshake response");var response;try{response=connectionResponseDeserialiser(message)}catch(e){return logger.debug("Unable to deserialise handshake response",e),closeReason=CloseReason.HANDSHAKE_ERROR,void transport.close()}logger.debug("Connection response: ",response.response),response.success&&fsm.change("connected")?(closeReason=CloseReason.TRANSPORT_ERROR,emitter.emit("connect",response)):(closeReason=CloseReason.HANDSHAKE_REJECTED,transport.close())}function dispatch(message){var bos=new BufferOutputStream;return Message.writeToBuffer(message,bos),transport.dispatch(bos.getBuffer())}var scheduledClose,closeReason,transport,emitter=Emitter.assign(this),fsm=FSM.create("disconnected",{connecting:["connected","disconnected","closed"],connected:["disconnecting","disconnected","closed"],disconnecting:["disconnected"],disconnected:["connecting","closed"],closed:[]});fsm.on("change",function(previous,current){logger.debug("State changed: "+previous+" -> "+current)}),this.connect=function(request,opts){return"disconnected"!==fsm.state?void logger.warn("Cannot connect, current state: ",fsm.state):void(fsm.change("connecting")&&(closeReason=CloseReason.CONNECTION_ERROR,transport=transports.get(opts),transport.on("data",onData),transport.on("close",onClose),transport.connect(request,handshake),scheduledClose=setTimeout(function(){logger.debug("Timed out connection attempt after "+CONNECT_TIMEOUT),closeReason=CloseReason.CONNECTION_TIMEOUT,transport.close()},CONNECT_TIMEOUT)))},this.send=function(message){return"connected"===fsm.state?dispatch(message):!1},this.close=function(reason){closeReason=reason,fsm.change("disconnecting")&&(dispatch(Message.create(Message.types.CLOSE_REQUEST)),scheduledClose=setTimeout(transport.close,CLOSE_TIMEOUT))},this.getState=function(){return fsm.state}}var connectionResponseDeserialiser=_dereq_("protocol/connection-response-deserialiser"),BufferOutputStream=(_dereq_("protocol/response-code"),_dereq_("io/buffer-output-stream")),CloseReason=_dereq_("v4-stack/close-reason"),Message=_dereq_("v4-stack/message"),Emitter=_dereq_("events/emitter"),logger=_dereq_("util/logger").create("Connection"),FSM=(_dereq_("util/function").curry,_dereq_("util/fsm")),CLOSE_TIMEOUT=global.DIFFUSION_CLOSE_TIMEOUT||1e3,CONNECT_TIMEOUT=global.DIFFUSION_CONNECT_TIMEOUT||1e4;module.exports=Connection}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"events/emitter":50,"io/buffer-output-stream":56,"protocol/connection-response-deserialiser":68,"protocol/response-code":70,"util/fsm":123,"util/function":124,"util/logger":126,"v4-stack/close-reason":132,"v4-stack/message":136}],135:[function(_dereq_,module){(function(Buffer){function encodeAsString(password){var bos=new BufferOutputStream;return serialiser.write(bos,password),bos.getBase64()}function decodeAsString(s){if(s){var bis=new BufferInputStream(new Buffer(s,"base64"));return serialiser.read(bis)}return null}var BufferOutputStream=_dereq_("io/buffer-output-stream"),BufferInputStream=_dereq_("io/buffer-input-stream"),serialiser=_dereq_("services/authentication/credentials-serialiser");module.exports={encodeAsString:encodeAsString,decodeAsString:decodeAsString}}).call(this,_dereq_("buffer").Buffer)},{buffer:2,"io/buffer-input-stream":55,"io/buffer-output-stream":56,"services/authentication/credentials-serialiser":78}],136:[function(_dereq_,module){(function(Buffer){function writeToBuffer(message,bos){bos.write(message.type),bos.writeString(getHeaderString(message)),bos.writeMany(message.getBuffer())}function WriteableMessage(fields){Message.call(this,fields.type,fields.encoding,fields,fields.buffer),BufferOutputStream.call(this,fields.buffer)}function Message(type,encoding,fields,data){this.type=type,this.encoding=encoding;for(var f in fields)this[f]=fields[f];this.data=data}var inherits=_dereq_("inherits"),BufferOutputStream=_dereq_("io/buffer-output-stream"),BufferInputStream=_dereq_("io/buffer-input-stream"),systemHeaders={20:["topic"],21:["topic"],22:["topic_set"],23:["topic_set"],24:["timestamp","queue_size"],25:["timestamp"],26:["username","password"],27:["username","password"],28:[],29:[],30:["topic","ack_id"],31:["topic","ack_id"],32:["ack_id"],33:["topic"],34:["topic"],35:["topic","topic_status"],36:["topic","command"],40:["topic","command_topic_category","command_topic_type"],41:["topic","notification_type"],48:["correlation_id"],84:["topic","correlation_id","fragment_number","total_fragments","total_size"],85:["topic","correlation_id","fragment_number","total_fragments","total_size"],98:["topic","correlation_id","fragment_number","total_fragments","total_size"]},types={TOPIC_LOAD:20,DELTA:21,SUBSCRIBE:22,UNSUBSCRIBE:23,PING_SERVER:24,PING_CLIENT:25,CREDENTIALS:26,CREDENTIALS_REJECTED:27,ABORT_NOTIFICATION:28,CLOSE_REQUEST:29,TOPIC_LOAD_ACK_REQUIRED:30,DELTA_ACK_REQUIRED:31,ACK:32,FETCH:33,FETCH_REPLY:34,TOPIC_STATUS_NOTIFICATION:35,COMMAND_MESSAGE:36,COMMAND_TOPIC_LOAD:40,COMMAND_TOPIC_NOTIFICATION:41,CANCEL_FRAGMENTED_MESSAGE_SET:48,TOPIC_LOAD_FRAGMENTED:84,DELTA_FRAGMENTED:85,FETCH_REPLY_FRAGMENTED:98},encoding={NONE:0,ENCRYPTION_REQUESTED:1,COMPRESSION_REQUESTED:2,BASE64_REQUESTED:3,ENCRYPTED:17,COMPRESSED:18,BASE64:19},parse=function(buffer){var bis=new BufferInputStream(buffer),type=bis.read(),headers=bis.readUntil(1).toString().split(""),body=bis.readMany(bis.count),fields={};return systemHeaders[type]&&systemHeaders[type].forEach(function(key){fields[key]=headers.shift()}),new Message(type,encoding.NONE,fields,body)},create=function(type){var fields;if(void 0===type||"number"==typeof type&&void 0===systemHeaders[type])throw"Invalid message type: "+type;return fields=type instanceof Object?type:{type:type},fields.encoding=fields.encoding||0,fields.buffer=fields.buffer||new Buffer(0),new WriteableMessage(fields)},getHeaderString=function(message){var sh=[];return systemHeaders[message.type].forEach(function(h){sh.push(message[h])}),sh.length>0?sh.join("")+"":""};inherits(WriteableMessage,BufferOutputStream),Message.prototype.isTopicMessage=function(){return void 0!==this.topic},Message.prototype.getInputStream=function(){return new BufferInputStream(this.data)},module.exports={types:types,parse:parse,create:create,encoding:encoding,getHeaderString:getHeaderString,writeToBuffer:writeToBuffer}}).call(this,_dereq_("buffer").Buffer)},{buffer:2,inherits:10,"io/buffer-input-stream":55,"io/buffer-output-stream":56}],137:[function(_dereq_,module){function Options(options){if(options=options||{},this.ssl=void 0!==options.ssl?options.ssl:DEFAULT_SSL,this.reconnect=void 0!==options.reconnect?options.reconnect:DEFAULT_RECONNECT,options.host&&options.host.indexOf(":")>-1){var parts=options.host.split(":");this.host=parts[0],this.port=parseInt(parts[1])}else this.host=options.host||DEFAULT_HOST,this.port=options.port||(this.ssl?DEFAULT_SSL_PORT:DEFAULT_PORT);options.credentials&&(this.credentials={principal:options.credentials.principal||DEFAULT_PRINCIPAL,password:options.credentials.password||DEFAULT_PASSWORD})}var DEFAULT_HOST="localhost",DEFAULT_PORT=80,DEFAULT_SSL_PORT=443,DEFAULT_SSL=!0,DEFAULT_RECONNECT=!0,DEFAULT_PRINCIPAL="",DEFAULT_PASSWORD="";Options.prototype["with"]=function(options){var k,o={};for(k in options)o[k]=options[k];for(k in this)void 0===o[k]&&(o[k]=this[k]);return new Options(o)},module.exports=Options},{}],138:[function(_dereq_,module){function Session(args){this.options=new Options("string"==typeof args?{host:args}:args),this.sessionID=void 0;var emitter=Emitter.assign(this),serviceRegistry=new ServiceRegistry,conversationSet=ConversationSet(function(cid,err){emitter.error(err)});serviceRegistry.add(Services.USER_PING,PingService),serviceRegistry.add(Services.SYSTEM_PING,PingService),serviceRegistry.add(Services.SUBSCRIPTION_NOTIFICATION,NotifySubscriptionService),serviceRegistry.add(Services.UNSUBSCRIPTION_NOTIFICATION,NotifyUnsubscriptionService);
var internalSession=new InternalSession(conversationSet,serviceRegistry,ConnectionFactory),self=this;internalSession.on({connect:function(sessionID){self.sessionID=sessionID.toString(),emitter.emit("connect",self)},reconnect:function(){emitter.emit("reconnect")},disconnect:function(reason){emitter.emit("disconnect",reason)},error:function(err){emitter.emit("error",err)},close:function(reason){emitter.emit("close",reason)}}),this.on("error",internalSession.close),features.forEach(function(feature){var instance=new feature(internalSession);for(var k in instance)this[k]=instance[k]}.bind(this)),this.connect=function(options){return internalSession.connect(self.options["with"](options)),self},this.close=function(){return internalSession.close(),self},this.isConnected=function(){return internalSession.isConnected()},this.security=new Security(internalSession,this),this.topics=new TopicControl(internalSession,this)}var Options=(_dereq_("inherits"),_dereq_("./options")),Emitter=_dereq_("events/emitter"),InternalSession=_dereq_("client/internal-session"),ServiceRegistry=_dereq_("client/service-registry"),ConversationSet=_dereq_("conversation/conversation-set"),ConnectionFactory=_dereq_("v4-stack/connection-factory"),Services=_dereq_("services/services"),PingService=_dereq_("api/services/ping-service"),NotifySubscriptionService=_dereq_("api/services/notify-subscription-service"),NotifyUnsubscriptionService=_dereq_("api/services/notify-unsubscription-service"),features=[_dereq_("api/features/topics")],Security=_dereq_("api/features/security").Security,TopicControl=_dereq_("api/features/topic-control");module.exports=Session},{"./options":137,"api/features/security":24,"api/features/topic-control":25,"api/features/topics":26,"api/services/notify-subscription-service":28,"api/services/notify-unsubscription-service":29,"api/services/ping-service":30,"client/internal-session":32,"client/service-registry":37,"conversation/conversation-set":48,"events/emitter":50,inherits:10,"services/services":95,"v4-stack/connection-factory":133}],139:[function(_dereq_,module){function TopicSelector(type,prefix,expression){this.type=type,this.prefix=prefix,this.expression=expression}var util=_dereq_("topics/topic-path-utils");TopicSelector.Prefix={PATH:">",SPLIT_PATH_PATTERN:"?",FULL_PATH_PATTERN:"*",SELECTOR_SET:"#"},TopicSelector.Type={PATH:TopicSelector.Prefix.PATH,SPLIT_PATH_PATTERN:TopicSelector.Prefix.SPLIT_PATH_PATTERN,FULL_PATH_PATTERN:TopicSelector.Prefix.FULL_PATH_PATTERN,SELECTOR_SET:TopicSelector.Prefix.SELECTOR_SET},TopicSelector.prototype.selects=function(topicPath){var canonical=util.canonicalise(topicPath);return 0===canonical.indexOf(this.prefix)&&this._doSelects(canonical)},TopicSelector.prototype.toString=function(){return this.expression},module.exports=TopicSelector},{"topics/topic-path-utils":117}],140:[function(_dereq_,module){var parser=_dereq_("topics/topic-selector-parser"),topicSelectors={parse:function(expression){return parser(expression)}};module.exports=topicSelectors},{"topics/topic-selector-parser":118}]},{},[15])(15)});